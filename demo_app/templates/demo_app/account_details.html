{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --tmobile-magenta: #E20074;
            --tmobile-magenta-light: #fbe4f2;
            --tmobile-gray: #6c757d;
        }
        body { background: #f5f5f7; color: #222; }
        .tmobile-header { background: #fff; color: var(--tmobile-magenta); padding: 1.5rem 0 1rem 0; border-bottom: 2px solid #eee; }
        .tmobile-logo { height: 40px; width: auto; max-width: 120px; margin-right: 1rem; }
        .tmobile-title { font-size: 2rem; font-weight: bold; color: var(--tmobile-magenta); margin-bottom: 0; }
        .add-line-btn { background: var(--tmobile-magenta); color: #fff; font-weight: 600; border-radius: 2rem; border: none; padding: 0.5rem 2rem; }
        .add-line-btn:hover { background: #b8005a; color: #fff; }
        .nav-tabs { border-bottom: none; margin-bottom: 0; }
        .nav-tabs .nav-link {
            border: none;
            border-radius: 0;
            color: var(--tmobile-gray);
            background: transparent;
            font-weight: 500;
            font-size: 1.1rem;
            margin-right: 0.5rem;
            padding: 0.75rem 2rem;
        }
        .nav-tabs .nav-link.active {
            background: var(--tmobile-magenta);
            color: #fff;
            border-radius: 0.5rem 0.5rem 0 0;
        }
        .tab-content { background: #fff; border-radius: 0 0 1rem 1rem; padding: 2rem 2rem 1.5rem 2rem; margin-bottom: 2rem; border-top: none; }
        .account-attributes {
            margin-bottom: 1.5rem;
        }
        .account-attributes .row {
            margin-bottom: 0.5rem;
        }
        .account-attr-label {
            color: var(--tmobile-gray);
            font-size: 1rem;
        }
        .account-attr-value {
            color: var(--tmobile-magenta);
            font-size: 1.1rem;
            font-weight: 500;
        }
        .account-attr-value.status {
            color: #111;
            font-weight: bold;
        }
        /* Lines Table */
        .lines-section {
            background: #fff;
            border-radius: 1rem;
            padding: 0;
            margin-bottom: 2rem;
        }
        .lines-header-bar {
            background: var(--tmobile-magenta);
            color: #fff;
            border-radius: 1rem 1rem 0 0;
            padding: 1rem 2rem 0.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .lines-header-bar h5 {
            margin: 0;
            font-weight: 600;
        }
        .lines-action-btns .btn {
            background: #fff;
            color: var(--tmobile-magenta);
            border-radius: 2rem;
            border: none;
            font-weight: 600;
            margin-right: 0.5rem;
            padding: 0.3rem 1.2rem;
        }
        .lines-action-btns .btn:last-child { margin-right: 0; }
        .lines-action-btns .btn:hover {
            background: #fbe4f2;
            color: #b8005a;
        }
        .lines-action-btns .btn:disabled {
            background: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .lines-action-btns .btn:disabled:hover {
            background: #e9ecef;
            color: #6c757d;
        }
        .lines-table thead th {
            background: var(--tmobile-magenta);
            color: #fff;
            border: none;
            font-weight: 600;
        }
        .lines-table tbody tr:nth-child(even) {
            background: var(--tmobile-magenta-light);
        }
        .lines-table tbody tr:nth-child(odd) {
            background: #fff;
        }
        .lines-table td, .lines-table th {
            vertical-align: middle;
        }
        /* Custom Checkbox */
        .form-check-input:checked {
            background-color: var(--tmobile-magenta);
            border-color: var(--tmobile-magenta);
        }
        .form-check-input:focus {
            box-shadow: 0 0 0 0.2rem rgba(226,0,116,.25);
        }
        /* Enhanced Search Input Styling */
        .search-section {
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        
        .search-container {
            position: relative;
        }
        
        .search-input-group {
            border-radius: 2rem;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .search-input-group:focus-within {
            box-shadow: 0 4px 16px rgba(226,0,116,0.2);
            transform: translateY(-1px);
        }
        
        .search-icon {
            background: #fff;
            border: none;
            color: var(--tmobile-magenta);
            padding: 0.75rem 1rem;
        }
        
        .search-input {
            border: none;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            background: #fff;
        }
        
        .search-input:focus {
            box-shadow: none;
            background: #fff;
        }
        
        .clear-search-btn {
            border: none;
            background: #fff;
            color: #6c757d;
            padding: 0.75rem 1rem;
            transition: color 0.2s ease;
        }
        
        .clear-search-btn:hover {
            color: var(--tmobile-magenta);
            background: #fff;
        }
        
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #fff;
            border: 1px solid #e9ecef;
            border-top: none;
            border-radius: 0 0 1rem 1rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .suggestion-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #f8f9fa;
            transition: background-color 0.2s ease;
        }
        
        .suggestion-item:hover {
            background-color: var(--tmobile-magenta-light);
            color: var(--tmobile-magenta);
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .search-stats {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.5rem;
        }
        
        .search-results-text {
            font-size: 0.875rem;
            color: var(--tmobile-gray);
            font-weight: 500;
        }
        
        .search-filters {
            display: flex;
            gap: 0.25rem;
        }
        
        .filter-btn {
            border-radius: 1rem;
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-color: #dee2e6;
            color: var(--tmobile-gray);
            transition: all 0.2s ease;
        }
        
        .filter-btn:hover {
            border-color: var(--tmobile-magenta);
            color: var(--tmobile-magenta);
        }
        
        .filter-btn.active {
            background-color: var(--tmobile-magenta);
            border-color: var(--tmobile-magenta);
            color: #fff;
        }
        
        /* Chatbot Styles */
        .chatbot-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: var(--tmobile-magenta);
            color: white;
            border: none;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(226,0,116,0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .chatbot-toggle:hover {
            background: #b8005a;
            transform: scale(1.1);
        }
        
        .chatbot-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: min(90vw, 420px);
            height: min(80vh, 640px);
            max-height: calc(100vh - 40px);
            background: white;
            border-radius: 1rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            z-index: 2000;
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 2px solid var(--tmobile-magenta);
        }
        
        .chatbot-header {
            background: var(--tmobile-magenta);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 1002;
            border-radius: 1rem 1rem 0 0;
            min-height: 56px;
        }
        
        .chatbot-title {
            font-weight: bold;
            margin: 0;
        }
        
        .chatbot-close {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            z-index: 1001;
        }
        
        .chatbot-close:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: scale(1.1);
        }
        
        .chatbot-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            min-height: 0; /* allow flex child to shrink within container */
        }
        
        .message {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            word-wrap: break-word;
        }
        
        .message.user {
            background: var(--tmobile-magenta-light);
            color: var(--tmobile-magenta);
            align-self: flex-end;
            border-bottom-right-radius: 0.25rem;
        }
        
        .message.assistant {
            background: #f8f9fa;
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 0.25rem;
        }
        
        .message.system {
            background: #e7f3ff;
            color: #0066cc;
            align-self: center;
            text-align: center;
            font-size: 0.9rem;
            max-width: 90%;
        }
        
        .typing-indicator {
            align-self: flex-start;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: #f8f9fa;
            border-radius: 1rem;
            border-bottom-left-radius: 0.25rem;
        }
        
        .typing-dots {
            display: flex;
            gap: 0.25rem;
        }
        
        .typing-dot {
            width: 6px;
            height: 6px;
            background: #666;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        .chatbot-input-area {
            padding: 1rem;
            border-top: 1px solid #e9ecef;
            background: #f8f9fa;
            flex-shrink: 0;
        }
        
        .chatbot-input-group {
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
        }
        
        .chatbot-input {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 1.5rem;
            padding: 0.75rem 1rem;
            resize: none;
            min-height: 40px;
            max-height: 120px;
            font-family: inherit;
        }
        
        .chatbot-input:focus {
            outline: none;
            border-color: var(--tmobile-magenta);
            box-shadow: 0 0 0 2px rgba(226,0,116,0.1);
        }
        
        .chatbot-send {
            background: var(--tmobile-magenta);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .chatbot-send:hover:not(:disabled) {
            background: #b8005a;
        }
        
        .chatbot-send:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .chatbot-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .suggestion-chip {
            background: white;
            border: 1px solid var(--tmobile-magenta);
            color: var(--tmobile-magenta);
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .suggestion-chip:hover {
            background: var(--tmobile-magenta);
            color: white;
        }
        
        /* Add a Line Modal Styles */
        .progress-container {
            position: relative;
        }
        
        .progress-steps {
            position: relative;
        }
        
        .progress-steps::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 30px;
            right: 30px;
            height: 2px;
            background: #e9ecef;
            z-index: 1;
        }
        
        .progress-step {
            position: relative;
            z-index: 2;
            text-align: center;
            flex: 1;
        }
        
        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e9ecef;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin: 0 auto 0.5rem;
            transition: all 0.3s ease;
        }
        
        .progress-step.active .step-circle {
            background: var(--tmobile-magenta);
            color: white;
        }
        
        .progress-step.completed .step-circle {
            background: var(--tmobile-magenta);
            color: white;
        }
        
        .step-label {
            font-size: 0.875rem;
            color: #6c757d;
            font-weight: 500;
        }
        
        .progress-step.active .step-label {
            color: var(--tmobile-magenta);
            font-weight: 600;
        }
        
        .progress-step.completed .step-label {
            color: var(--tmobile-magenta);
        }
        
        .step-content {
            display: none;
        }
        
        .step-content.active {
            display: block;
        }
        
        /* Plan Options Styling */
        .plan-option {
            border: 1px solid #e9ecef;
            border-radius: 0.5rem;
            padding: 1rem;
            transition: all 0.3s ease;
        }
        
        .plan-option:hover {
            border-color: var(--tmobile-magenta);
            background: var(--tmobile-magenta-light);
        }
        
        .plan-option .form-check-input:checked + .form-check-label {
            color: var(--tmobile-magenta);
        }
        
        .plan-option .form-check-input:checked ~ .plan-option {
            border-color: var(--tmobile-magenta);
            background: var(--tmobile-magenta-light);
        }
        
        .plan-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .plan-price {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--tmobile-magenta);
            margin-bottom: 0.25rem;
        }
        
        .plan-details-link {
            color: var(--tmobile-magenta);
            text-decoration: none;
            font-size: 0.875rem;
        }
        
        .plan-details-link:hover {
            text-decoration: underline;
        }
        
        /* Protection Options Styling */
        .protection-option {
            border: 1px solid #e9ecef;
            border-radius: 0.5rem;
            padding: 1rem;
            transition: all 0.3s ease;
        }
        
        .protection-option:hover {
            border-color: var(--tmobile-magenta);
            background: var(--tmobile-magenta-light);
        }
        
        .protection-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .protection-price {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--tmobile-magenta);
            margin-bottom: 0.5rem;
        }
        
        .protection-features li {
            color: #6c757d;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }
        
        /* Trade-in Options Styling */
        .trade-in-option {
            border: 1px solid #e9ecef;
            border-radius: 0.5rem;
            padding: 1rem;
            transition: all 0.3s ease;
        }
        
        .trade-in-option:hover {
            border-color: var(--tmobile-magenta);
            background: var(--tmobile-magenta-light);
        }
        
        .trade-in-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .trade-in-description {
            font-size: 0.875rem;
        }
        
        /* Summary Styling */
        .summary-item {
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 1rem;
        }
        
        .summary-item:last-child {
            border-bottom: none;
        }
        
        /* Device Details Styling */
        #deviceDetails .card {
            border: 1px solid var(--tmobile-magenta);
            background: var(--tmobile-magenta-light);
        }
        
        /* Modal Footer Button States */
        .modal-footer .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* Form Validation Styling */
        .form-select.is-invalid,
        .form-control.is-invalid {
            border-color: #dc3545;
        }
        
        .invalid-feedback {
            display: block;
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        
        /* Upgrade Modal Styles */
        .upgrade-option {
            border: 1px solid #e9ecef;
            border-radius: 0.5rem;
            padding: 1rem;
            transition: all 0.3s ease;
        }
        
        .upgrade-option:hover {
            border-color: var(--tmobile-magenta);
            background: var(--tmobile-magenta-light);
        }
        
        .upgrade-option .form-check-input:checked + .form-check-label {
            color: var(--tmobile-magenta);
        }
        
        .upgrade-option .form-check-input:checked ~ .upgrade-option {
            border-color: var(--tmobile-magenta);
            background: var(--tmobile-magenta-light);
        }
        
        .upgrade-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .upgrade-description {
            font-size: 0.875rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="tmobile-header">
        <div class="container d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <a href="/dashboard/" class="d-flex align-items-center text-decoration-none">
                    <img src="{% static 'logo.svg' %}" alt="T-Mobile Logo" class="tmobile-logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';">
                    <span class="tmobile-text-logo" style="display: none; font-size: 1.5rem; font-weight: bold; color: #E20074; margin-right: 1rem;">T-Mobile</span>
                    <span class="tmobile-title">ABC Limited</span>
                </a>
            </div>
            <button class="add-line-btn" id="addLineBtn">ADD A LINE</button>
        </div>
    </div>
    <div class="container">
        <!-- Tabs -->
        <ul class="nav nav-tabs mt-4" id="accountTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab">Account Details</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="billing-tab" data-bs-toggle="tab" data-bs-target="#billing" type="button" role="tab">Billing Statements</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button" role="tab">Reports</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">Account History</button>
            </li>
        </ul>
        <div class="tab-content" id="accountTabsContent">
            <!-- Account Details Tab -->
            <div class="tab-pane fade show active" id="details" role="tabpanel">
                <div class="account-attributes">
                    <div class="row mb-2">
                        <div class="col-md-4 mb-2">
                            <div class="account-attr-label">Account Number</div>
                            <div class="account-attr-value">{{ account.account_number }}</div>
                        </div>
                        <div class="col-md-4 mb-2">
                            <div class="account-attr-label">No. of lines</div>
                            <div class="account-attr-value">{{ account.number_of_lines }}</div>
                        </div>
                        <div class="col-md-4 mb-2">
                            <div class="account-attr-label">Created On</div>
                            <div class="account-attr-value">{{ account.created_on|date:"d M Y" }}</div>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-4 mb-2">
                            <div class="account-attr-label">Last Payment Date</div>
                            <div class="account-attr-value">{{ account.last_payment_date|date:"d M Y"|default:"N/A" }}</div>
                        </div>
                        <div class="col-md-4 mb-2">
                            <div class="account-attr-label">Payment Due Date</div>
                            <div class="account-attr-value">{{ account.payment_due_date|date:"d M Y"|default:"N/A" }}</div>
                        </div>
                        <div class="col-md-4 mb-2">
                            <div class="account-attr-label">Account Type</div>
                            <div class="account-attr-value">{{ account.get_account_type_display }}</div>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-4 mb-2">
                            <div class="account-attr-label">Last Modified On</div>
                            <div class="account-attr-value">{{ account.last_modified_on|date:"d M Y" }}</div>
                        </div>
                        <div class="col-md-4 mb-2">
                            <div class="account-attr-label">Status</div>
                            <div class="account-attr-value status">{{ account.get_status_display }}</div>
                        </div>
                    </div>
                </div>
                <!-- Lines Management Section -->
                <div class="lines-section">
                    <div class="lines-header-bar">
                        <h5>Lines Details</h5>
                        <div class="lines-action-btns">
                            <button class="btn" id="upgradeBtn" disabled>Upgrade</button>
                            <button class="btn" id="addServicesBtn" disabled>Add Services</button>
                            <button class="btn" id="suspendBtn" disabled>Suspend</button>
                            <button class="btn" id="restoreBtn" disabled>Restore</button>
                            <button class="btn" id="simSwapBtn" disabled>SIM SWAP</button>
                            <button class="btn" id="changeMobileNumberBtn" disabled>Change Mobile Number</button>
                        </div>
                    </div>
                    <!-- Search Section -->
                    <div class="search-section p-3 border-bottom">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <div class="search-container">
                                    <div class="input-group search-input-group">
                                        <span class="input-group-text search-icon">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <circle cx="11" cy="11" r="8"></circle>
                                                <path d="m21 21-4.35-4.35"></path>
                                            </svg>
                                        </span>
                                        <input type="text" class="form-control search-input" id="linesSearchInput" placeholder="Search lines by name, MSDN, employee name, employee number, date, or status...">
                                        <button class="btn btn-outline-secondary clear-search-btn" id="clearSearchBtn" type="button" style="display: none;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                            </svg>
                                        </button>
                                    </div>
                                    <div class="search-suggestions" id="searchSuggestions" style="display: none;">
                                        <div class="suggestion-item" data-search="john">John Smith</div>
                                        <div class="suggestion-item" data-search="sarah">Sarah Johnson</div>
                                        <div class="suggestion-item" data-search="michael">Michael Brown</div>
                                        <div class="suggestion-item" data-search="emily">Emily Davis</div>
                                        <div class="suggestion-item" data-search="david">David Wilson</div>
                                        <div class="suggestion-item" data-search="lisa">Lisa Anderson</div>
                                        <div class="suggestion-item" data-search="jennifer">Jennifer Martinez</div>
                                        <div class="suggestion-item" data-search="christopher">Christopher Lee</div>
                                        <div class="suggestion-item" data-search="amanda">Amanda Garcia</div>
                                        <div class="suggestion-item" data-search="kevin">Kevin Rodriguez</div>
                                        <div class="suggestion-item" data-search="nicole">Nicole White</div>
                                        <div class="suggestion-item" data-search="thomas">Thomas Clark</div>
                                        <div class="suggestion-item" data-search="rachel">Rachel Lewis</div>
                                        <div class="suggestion-item" data-search="daniel">Daniel Hall</div>
                                        <div class="suggestion-item" data-search="michelle">Michelle Young</div>
                                        <div class="suggestion-item" data-search="james">James Allen</div>
                                        <div class="suggestion-item" data-search="stephanie">Stephanie King</div>
                                        <div class="suggestion-item" data-search="ryan">Ryan Wright</div>
                                        <div class="suggestion-item" data-search="lauren">Lauren Scott</div>
                                        <div class="suggestion-item" data-search="brandon">Brandon Green</div>
                                        <div class="suggestion-item" data-search="ashley">Ashley Baker</div>
                                        <div class="suggestion-item" data-search="matthew">Matthew Adams</div>
                                        <div class="suggestion-item" data-search="jessica">Jessica Nelson</div>
                                        <div class="suggestion-item" data-search="andrew">Andrew Carter</div>
                                        <div class="suggestion-item" data-search="melissa">Melissa Mitchell</div>
                                        <div class="suggestion-item" data-search="robert">Robert Perez</div>
                                        <div class="suggestion-item" data-search="kimberly">Kimberly Roberts</div>
                                        <div class="suggestion-item" data-search="steven">Steven Turner</div>
                                        <div class="suggestion-item" data-search="amanda">Amanda Phillips</div>
                                        <div class="suggestion-item" data-search="active">Active</div>
                                        <div class="suggestion-item" data-search="555">+1-555-0123</div>
                                        <div class="suggestion-item" data-search="emp">EMP001</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="search-stats">
                                    <span class="search-results-text" id="searchResults">Showing all lines</span>
                                    <div class="search-filters">
                                        <button class="btn btn-sm btn-outline-secondary filter-btn active" data-filter="all">All</button>
                                        <button class="btn btn-sm btn-outline-secondary filter-btn" data-filter="active">Active</button>
                                        <button class="btn btn-sm btn-outline-secondary filter-btn" data-filter="suspended">Suspended</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table lines-table align-middle mb-0">
                            <thead>
                                <tr>
                                    <th scope="col" style="width:40px"><input class="form-check-input" type="checkbox" /></th>
                                    <th scope="col">Line Name</th>
                                    <th scope="col">MSDN</th>
                                    <th scope="col">Employee Name</th>
                                    <th scope="col">Employee Number</th>
                                    <th scope="col">Added on</th>
                                    <th scope="col">Payment Due</th>
                                    <th scope="col">Status</th>
                                    <th scope="col">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for line in lines %}
                                <tr data-line-id="{{ line.id }}">
                                    <td><input class="form-check-input line-checkbox" type="checkbox" data-line-id="{{ line.id }}" /></td>
                                    <td>{{ line.line_name }}</td>
                                    <td>{{ line.msdn }}</td>
                                    <td>{{ line.employee_name }}</td>
                                    <td>{{ line.employee_number }}</td>
                                    <td>{{ line.added_on|date:"d M Y" }}</td>
                                    <td>{{ line.payment_due_date|date:"d M Y"|default:"N/A" }}</td>
                                    <td><span class="account-attr-value">{{ line.get_status_display }}</span></td>
                                    <td>
                                        <button class="btn btn-outline-primary btn-sm edit-line-btn" 
                                                data-line-id="{{ line.id }}" 
                                                data-line-name="{{ line.line_name }}" 
                                                data-employee-name="{{ line.employee_name }}" 
                                                data-payment-date="{{ line.payment_due_date|date:'Y-m-d'|default:'' }}">
                                            <i class="bi bi-pencil"></i> Edit Details
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="9" class="text-center py-4">No lines found for this account.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- Other Tabs Placeholder -->
            <div class="tab-pane fade" id="billing" role="tabpanel">
                <div class="text-center py-5">Billing Statements content coming soon.</div>
            </div>
            <div class="tab-pane fade" id="reports" role="tabpanel">
                <div class="text-center py-5">Reports content coming soon.</div>
            </div>
            <div class="tab-pane fade" id="history" role="tabpanel">
                <div class="text-center py-5">Account History content coming soon.</div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Edit Payment Date Modal -->
    <div class="modal fade" id="editPaymentDateModal" tabindex="-1" aria-labelledby="editPaymentDateModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" style="background: var(--tmobile-magenta); color: white;">
                    <h5 class="modal-title" id="editPaymentDateModalLabel">Edit Line Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label"><strong>Line:</strong> <span id="editLineName"></span></label>
                    </div>
                    <div class="mb-3">
                        <label for="editEmployeeName" class="form-label">Employee Name</label>
                        <input type="text" class="form-control" id="editEmployeeName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editPaymentDate" class="form-label">Payment Due Date</label>
                        <input type="date" class="form-control" id="editPaymentDate" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="savePaymentDateBtn">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Coming Soon Modal -->
    <div class="modal fade" id="comingSoonModal" tabindex="-1" aria-labelledby="comingSoonModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="comingSoonModalLabel">Coming Soon</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="comingSoonModalBody">
            This feature is coming soon.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Service Modal -->
    <div class="modal fade" id="addServiceModal" tabindex="-1" aria-labelledby="addServiceModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addServiceModalLabel">Add a Service</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="addServiceForm">
              <div class="mb-3">
                <label for="serviceSelect" class="form-label">Select International Pass:</label>
                <select class="form-select" id="serviceSelect" required>
                  <option value="">Choose an option...</option>
                  <option value="1day">$1: 1 Day (512MB) International Pass</option>
                  <option value="10day">$35: 10 Day (5GB) International Pass</option>
                  <option value="30day">$50: 30 Day (15GB) International Pass</option>
                </select>
              </div>
              
              <!-- Service Details Section -->
              <div id="serviceDetails" class="mt-4" style="display: none;">
                <h6 class="text-primary mb-3">Service Details</h6>
                <div id="serviceDetailsContent"></div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="nextBtn" disabled>Next</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Checkout Modal -->
    <div class="modal fade" id="checkoutModal" tabindex="-1" aria-labelledby="checkoutModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header" style="background: var(--tmobile-magenta); color: white;">
            <h5 class="modal-title" id="checkoutModalLabel">Checkout</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-8">
                <h6 class="mb-3">Order Summary</h6>
                <div class="card mb-3">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                      <div>
                        <h6 class="card-title mb-2" id="checkoutServiceTitle">Selected Service</h6>
                        <div id="checkoutServiceFeatures" class="text-muted small"></div>
                      </div>
                      <div class="text-end">
                        <span class="h5 text-primary" id="checkoutServicePrice">$0</span>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="mb-4">
                  <h6 class="mb-3">Payment Method</h6>
                  <div class="card">
                    <div class="card-body">
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="paymentMethod" id="creditCard" checked>
                        <label class="form-check-label" for="creditCard">
                          <strong>Credit Card ending in 1234</strong>
                          <div class="text-muted small">Visa •••• 1234</div>
                        </label>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="col-md-4">
                <div class="card bg-light">
                  <div class="card-body">
                    <h6 class="card-title">Billing Summary</h6>
                    <hr>
                    <div class="d-flex justify-content-between mb-2">
                      <span>Subtotal:</span>
                      <span id="checkoutSubtotal">$0.00</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                      <span>Taxes & Fees:</span>
                      <span id="checkoutTaxes">$0.00</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between mb-3">
                      <strong>Total:</strong>
                      <strong class="text-primary" id="checkoutTotal">$0.00</strong>
                    </div>
                    <div class="text-muted small">
                      <p class="mb-2">• Service will be activated immediately upon payment</p>
                      <p class="mb-0">• You will receive confirmation via SMS and email</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="backToServiceBtn">Back</button>
            <button type="button" class="btn btn-success" id="completeOrderBtn">Complete Order</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Mirror Line Modal -->
    <div class="modal fade" id="mirrorLineModal" tabindex="-1" aria-labelledby="mirrorLineModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header" style="background: var(--tmobile-magenta); color: white;">
            <h5 class="modal-title" id="mirrorLineModalLabel">Mirror a Line</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- Step 1: Select Line to Mirror -->
            <div id="mirrorStep1">
              <h6 class="mb-4">Select a line to mirror</h6>
              <p class="text-muted mb-4">Choose an existing line to copy its device, plan, and protection settings for your new line.</p>
              
              <div class="mb-3">
                <label for="lineToMirrorSelect" class="form-label">Select Line:</label>
                <select class="form-select" id="lineToMirrorSelect" required>
                  <option value="">Choose a line to mirror...</option>
                  {% for line in lines %}
                  <option value="{{ line.id }}" data-line-name="{{ line.line_name }}" data-employee-name="{{ line.employee_name }}" data-msdn="{{ line.msdn }}">
                    {{ line.line_name }} - {{ line.employee_name }} ({{ line.msdn }})
                  </option>
                  {% endfor %}
                </select>
              </div>
              
              <div id="selectedLineDetails" class="card mt-3" style="display: none;">
                <div class="card-body">
                  <h6 class="card-title">Line Details to Mirror</h6>
                  <div class="row">
                    <div class="col-md-6">
                      <p><strong>Line Name:</strong> <span id="mirrorLineName"></span></p>
                      <p><strong>Employee:</strong> <span id="mirrorEmployeeName"></span></p>
                      <p><strong>Phone Number:</strong> <span id="mirrorMsdn"></span></p>
                    </div>
                    <div class="col-md-6">
                      <p><strong>Device:</strong> <span id="mirrorDevice">Not specified</span></p>
                      <p><strong>Plan:</strong> <span id="mirrorPlan">Not specified</span></p>
                      <p><strong>Protection:</strong> <span id="mirrorProtection">Not specified</span></p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Step 2: Enter New Employee Details -->
            <div id="mirrorStep2" style="display: none;">
              <h6 class="mb-4">Enter New Employee Details</h6>
              <p class="text-muted mb-4">Provide the details for the new line. Device, plan, and protection settings will be copied from the selected line.</p>
              
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group mb-3">
                    <label for="newEmployeeName" class="form-label">Employee Name *</label>
                    <input type="text" class="form-control" id="newEmployeeName" placeholder="Enter employee name" required>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group mb-3">
                    <label for="newLineName" class="form-label">Line Name</label>
                    <input type="text" class="form-control" id="newLineName" placeholder="Auto-generated">
                  </div>
                </div>
              </div>
              
              <div class="card mt-3">
                <div class="card-body">
                  <h6 class="card-title">Mirrored Settings</h6>
                  <div class="row">
                    <div class="col-md-4">
                      <p><strong>Device:</strong> <span id="mirrorDevice2">Not specified</span></p>
                    </div>
                    <div class="col-md-4">
                      <p><strong>Plan:</strong> <span id="mirrorPlan2">Not specified</span></p>
                    </div>
                    <div class="col-md-4">
                      <p><strong>Protection:</strong> <span id="mirrorProtection2">Not specified</span></p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="mirrorBackBtn" style="display: none;">Back</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="mirrorNextBtn">Next</button>
            <button type="button" class="btn btn-success" id="mirrorCompleteBtn" style="display: none;">Complete</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Upgrade Lines Modal -->
    <div class="modal fade" id="upgradeModal" tabindex="-1" aria-labelledby="upgradeModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
          <div class="modal-header" style="background: var(--tmobile-magenta); color: white;">
            <h5 class="modal-title" id="upgradeModalLabel">Upgrade Lines</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- Progress Bar -->
            <div class="progress-container mb-4">
              <div class="progress-steps d-flex justify-content-between align-items-center">
                <div class="progress-step active" data-step="1">
                  <div class="step-circle">1</div>
                  <div class="step-label">Select Lines</div>
                </div>
                <div class="progress-step" data-step="2">
                  <div class="step-circle">2</div>
                  <div class="step-label">Upgrade Type</div>
                </div>
                <div class="progress-step" data-step="3">
                  <div class="step-circle">3</div>
                  <div class="step-label">New Device</div>
                </div>
                <div class="progress-step" data-step="4">
                  <div class="step-circle">4</div>
                  <div class="step-label">New Plan</div>
                </div>
                <div class="progress-step" data-step="5">
                  <div class="step-circle">5</div>
                  <div class="step-label">Summary</div>
                </div>
                <div class="progress-step" data-step="6">
                  <div class="step-circle">6</div>
                  <div class="step-label">Checkout</div>
                </div>
              </div>
            </div>

            <!-- Step Content -->
            <div id="upgradeStepContent">
              <!-- Step 1: Select Lines -->
              <div class="step-content active" id="upgradeStep1">
                <h6 class="mb-4">Select Lines to Upgrade</h6>
                <p class="text-muted mb-4">Choose which lines you want to upgrade. You can upgrade multiple lines at once.</p>
                
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th><input type="checkbox" id="upgradeSelectAll" class="form-check-input"></th>
                        <th>Line Name</th>
                        <th>Employee</th>
                        <th>Current Device</th>
                        <th>Current Plan</th>
                        <th>Status</th>
                      </tr>
                    </thead>
                    <tbody id="upgradeLinesTableBody">
                      <!-- Lines will be populated here -->
                    </tbody>
                  </table>
                </div>
                
                <div class="alert alert-info mt-3">
                  <strong>Selected Lines:</strong> <span id="upgradeSelectedCount">0</span>
                </div>
              </div>

              <!-- Step 2: Upgrade Type -->
              <div class="step-content" id="upgradeStep2">
                <h6 class="mb-4">Choose Upgrade Type</h6>
                <p class="text-muted mb-4">Select what type of upgrade you want for the selected lines.</p>
                
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-check upgrade-option mb-4">
                      <input class="form-check-input" type="radio" name="upgradeType" id="deviceUpgrade" value="device" checked>
                      <label class="form-check-label" for="deviceUpgrade">
                        <div class="upgrade-name">Device Upgrade</div>
                        <div class="upgrade-description">Upgrade to a newer device with same plan</div>
                      </label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-check upgrade-option mb-4">
                      <input class="form-check-input" type="radio" name="upgradeType" id="planUpgrade" value="plan">
                      <label class="form-check-label" for="planUpgrade">
                        <div class="upgrade-name">Plan Upgrade</div>
                        <div class="upgrade-description">Upgrade to a better plan with same device</div>
                      </label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-check upgrade-option mb-4">
                      <input class="form-check-input" type="radio" name="upgradeType" id="fullUpgrade" value="full">
                      <label class="form-check-label" for="fullUpgrade">
                        <div class="upgrade-name">Full Upgrade</div>
                        <div class="upgrade-description">Upgrade both device and plan</div>
                      </label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-check upgrade-option mb-4">
                      <input class="form-check-input" type="radio" name="upgradeType" id="protectionUpgrade" value="protection">
                      <label class="form-check-label" for="protectionUpgrade">
                        <div class="upgrade-name">Protection Upgrade</div>
                        <div class="upgrade-description">Add or upgrade device protection</div>
                      </label>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Step 3: New Device (if applicable) -->
              <div class="step-content" id="upgradeStep3">
                <h6 class="mb-4">Select New Device</h6>
                <p class="text-muted mb-4">Choose the new device for your upgrade.</p>
                
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group mb-3">
                      <label class="form-label">Device Type</label>
                      <select class="form-select" id="upgradeDeviceType">
                        <option value="">Choose device type...</option>
                        <option value="iphone">iPhone</option>
                        <option value="samsung">Samsung</option>
                        <option value="google">Google Pixel</option>
                        <option value="motorola">Motorola</option>
                        <option value="lg">LG</option>
                      </select>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group mb-3">
                      <label class="form-label">Device Model</label>
                      <select class="form-select" id="upgradeDeviceModel" disabled>
                        <option value="">Select device type first...</option>
                      </select>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-4">
                    <div class="form-group mb-3">
                      <label class="form-label">Color</label>
                      <select class="form-select" id="upgradeDeviceColor" disabled>
                        <option value="">Select model first...</option>
                      </select>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-group mb-3">
                      <label class="form-label">Storage</label>
                      <select class="form-select" id="upgradeDeviceStorage" disabled>
                        <option value="">Select model first...</option>
                      </select>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-group mb-3">
                      <label class="form-label">Quantity</label>
                      <select class="form-select" id="upgradeDeviceQuantity">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                      </select>
                    </div>
                  </div>
                </div>
                
                <div id="upgradeDeviceDetails" class="mt-3" style="display: none;">
                  <div class="card">
                    <div class="card-body">
                      <div class="row align-items-center">
                        <div class="col-md-3">
                          <img id="upgradeDeviceImage" src="" alt="Device" class="img-fluid" style="max-height: 100px;">
                        </div>
                        <div class="col-md-9">
                          <h6 id="upgradeDeviceTitle">Device Details</h6>
                          <p id="upgradeDeviceDescription" class="text-muted mb-2"></p>
                          <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted">MSRP:</span>
                            <span class="h6 mb-0" id="upgradeDeviceMSRP">$0</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Step 4: New Plan (if applicable) -->
              <div class="step-content" id="upgradeStep4">
                <h6 class="mb-4">Select New Plan</h6>
                <p class="text-muted mb-4">Choose the new plan for your upgrade.</p>
                
                <div class="row">
                  <div class="col-md-6">
                    <h6 class="mb-3">Business Plans</h6>
                    <div class="plan-options">
                      <div class="form-check plan-option mb-3">
                        <input class="form-check-input" type="radio" name="upgradePlanOption" id="upgradePlan1" value="business_individual_20">
                        <label class="form-check-label" for="upgradePlan1">
                          <div class="plan-name">Business Individual Value Unlimited Talk & Text</div>
                          <div class="plan-price">$20.00/mo.</div>
                          <a href="#" class="plan-details-link">View plan details</a>
                        </label>
                      </div>
                      <div class="form-check plan-option mb-3">
                        <input class="form-check-input" type="radio" name="upgradePlanOption" id="upgradePlan2" value="one_plan_tfb_25">
                        <label class="form-check-label" for="upgradePlan2">
                          <div class="plan-name">ONE Plan TFB TE</div>
                          <div class="plan-price">$25.00/mo.</div>
                          <a href="#" class="plan-details-link">View plan details</a>
                        </label>
                      </div>
                      <div class="form-check plan-option mb-3">
                        <input class="form-check-input" type="radio" name="upgradePlanOption" id="upgradePlan3" value="one_plan_voice_tablet_35">
                        <label class="form-check-label" for="upgradePlan3">
                          <div class="plan-name">One Plan Voice and Tablet For Enterprise</div>
                          <div class="plan-price">$35.00/mo.</div>
                          <a href="#" class="plan-details-link">View plan details</a>
                        </label>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <h6 class="mb-3">Premium Plans</h6>
                    <div class="plan-options">
                      <div class="form-check plan-option mb-3">
                        <input class="form-check-input" type="radio" name="upgradePlanOption" id="upgradePlan4" value="business_individual_60">
                        <label class="form-check-label" for="upgradePlan4">
                          <div class="plan-name">Business Individual Value Unlimited Talk & Text</div>
                          <div class="plan-price">$60.00/mo.</div>
                          <a href="#" class="plan-details-link">View plan details</a>
                        </label>
                      </div>
                      <div class="form-check plan-option mb-3">
                        <input class="form-check-input" type="radio" name="upgradePlanOption" id="upgradePlan5" value="one_plan_tfb_65">
                        <label class="form-check-label" for="upgradePlan5">
                          <div class="plan-name">ONE Plan TFB TE</div>
                          <div class="plan-price">$65.00/mo.</div>
                          <a href="#" class="plan-details-link">View plan details</a>
                        </label>
                      </div>
                      <div class="form-check plan-option mb-3">
                        <input class="form-check-input" type="radio" name="upgradePlanOption" id="upgradePlan6" value="one_plan_voice_tablet_75">
                        <label class="form-check-label" for="upgradePlan6">
                          <div class="plan-name">One Plan Voice and Tablet For Enterprise</div>
                          <div class="plan-price">$75.00/mo.</div>
                          <a href="#" class="plan-details-link">View plan details</a>
                        </label>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Step 5: Summary -->
              <div class="step-content" id="upgradeStep5">
                <h6 class="mb-4">Upgrade Summary</h6>
                <div class="summary-container">
                  <div class="row">
                    <div class="col-md-8">
                      <div class="card mb-3">
                        <div class="card-body">
                          <h6 class="card-title">Lines to Upgrade</h6>
                          <div id="upgradeSummaryLines">
                            <!-- Selected lines will be shown here -->
                          </div>
                        </div>
                      </div>
                      
                      <div class="card mb-3">
                        <div class="card-body">
                          <h6 class="card-title">Upgrade Details</h6>
                          <div id="upgradeSummaryDetails">
                            <!-- Upgrade details will be shown here -->
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="card bg-light">
                        <div class="card-body">
                          <h6 class="card-title">Pricing Summary</h6>
                          <hr>
                          <div class="d-flex justify-content-between mb-2">
                            <span>Device (24 mo.):</span>
                            <span id="upgradeSummaryDeviceMonthly">$0.00/mo.</span>
                          </div>
                          <div class="d-flex justify-content-between mb-2">
                            <span>Plan Change:</span>
                            <span id="upgradeSummaryPlanChange">$0.00/mo.</span>
                          </div>
                          <hr>
                          <div class="d-flex justify-content-between mb-2">
                            <strong>Total Monthly Change:</strong>
                            <strong class="text-primary" id="upgradeSummaryTotalChange">$0.00/mo.</strong>
                          </div>
                          <div class="d-flex justify-content-between mb-2">
                            <span>Due Now:</span>
                            <span id="upgradeSummaryDueNow">$0.00</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Step 6: Checkout -->
              <div class="step-content" id="upgradeStep6">
                <h6 class="mb-4">Complete Upgrade</h6>
                <div class="row">
                  <div class="col-md-8">
                    <div class="card mb-4">
                      <div class="card-body">
                        <h6 class="card-title mb-3">Upgrade Summary</h6>
                        <div id="upgradeCheckoutSummary">
                          <!-- Checkout summary will be populated here -->
                        </div>
                      </div>
                    </div>
                    <div class="card">
                      <div class="card-body">
                        <h6 class="card-title mb-3">Payment Method</h6>
                        <div class="form-check">
                          <input class="form-check-input" type="radio" name="upgradePaymentMethod" id="upgradeCreditCard" checked>
                          <label class="form-check-label" for="upgradeCreditCard">
                            <strong>Credit Card ending in 1234</strong>
                            <div class="text-muted small">Visa •••• 1234</div>
                          </label>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="card bg-light">
                      <div class="card-body">
                        <h6 class="card-title">Billing Summary</h6>
                        <hr>
                        <div class="d-flex justify-content-between mb-2">
                          <span>Subtotal:</span>
                          <span id="upgradeCheckoutSubtotal">$0.00</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                          <span>Taxes & Fees:</span>
                          <span id="upgradeCheckoutTaxes">$0.00</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-3">
                          <strong>Total:</strong>
                          <strong class="text-primary" id="upgradeCheckoutTotal">$0.00</strong>
                        </div>
                        <div class="text-muted small">
                          <p class="mb-2">• Upgrade will be processed immediately</p>
                          <p class="mb-2">• New devices will be shipped within 2-3 business days</p>
                          <p class="mb-0">• You will receive confirmation via SMS and email</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="upgradePrevBtn" style="display: none;">Back</button>
            <button type="button" class="btn btn-primary" id="upgradeNextBtn">Next</button>
            <button type="button" class="btn btn-success" id="upgradeCompleteBtn" style="display: none;">Complete Upgrade</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add a Line Modal -->
    <div class="modal fade" id="addLineModal" tabindex="-1" aria-labelledby="addLineModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
          <div class="modal-header" style="background: var(--tmobile-magenta); color: white;">
            <h5 class="modal-title" id="addLineModalLabel">Add a Line</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- Progress Bar -->
            <div class="progress-container mb-4">
              <div class="progress-steps d-flex justify-content-between align-items-center">
                <div class="progress-step active" data-step="1">
                  <div class="step-circle">1</div>
                  <div class="step-label">Select Device</div>
                </div>
                <div class="progress-step" data-step="2">
                  <div class="step-circle">2</div>
                  <div class="step-label">Plan Options</div>
                </div>
                <div class="progress-step" data-step="3">
                  <div class="step-circle">3</div>
                  <div class="step-label">Device Protection</div>
                </div>
                <div class="progress-step" data-step="4">
                  <div class="step-circle">4</div>
                  <div class="step-label">Trade-in</div>
                </div>
                <div class="progress-step" data-step="5">
                  <div class="step-circle">5</div>
                  <div class="step-label">Summary</div>
                </div>
                <div class="progress-step" data-step="6">
                  <div class="step-circle">6</div>
                  <div class="step-label">Checkout</div>
                </div>
              </div>
            </div>

            <!-- Step Content -->
            <div id="stepContent">
              <!-- Step 1: Select Device -->
              <div class="step-content active" id="step1">
                <h6 class="mb-4">Select Device</h6>
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group mb-3">
                      <label class="form-label">Device Type</label>
                      <select class="form-select" id="deviceType">
                        <option value="">Choose device type...</option>
                        <option value="iphone">iPhone</option>
                        <option value="samsung">Samsung</option>
                        <option value="google">Google Pixel</option>
                        <option value="motorola">Motorola</option>
                        <option value="lg">LG</option>
                      </select>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group mb-3">
                      <label class="form-label">Device Model</label>
                      <select class="form-select" id="deviceModel" disabled>
                        <option value="">Select device type first...</option>
                      </select>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-4">
                    <div class="form-group mb-3">
                      <label class="form-label">Color</label>
                      <select class="form-select" id="deviceColor" disabled>
                        <option value="">Select model first...</option>
                      </select>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-group mb-3">
                      <label class="form-label">Storage</label>
                      <select class="form-select" id="deviceStorage" disabled>
                        <option value="">Select model first...</option>
                      </select>
                    </div>
                  </div>
                                     <div class="col-md-4">
                     <div class="form-group mb-3">
                       <label class="form-label">Quantity</label>
                       <select class="form-select" id="deviceQuantity">
                         <option value="1">1</option>
                         <option value="2">2</option>
                         <option value="3">3</option>
                         <option value="4">4</option>
                         <option value="5">5</option>
                       </select>
                     </div>
                   </div>
                 </div>
                 <div class="row">
                   <div class="col-md-6">
                     <div class="form-group mb-3">
                       <label class="form-label">Area Code</label>
                       <select class="form-select" id="areaCode">
                         <option value="">Choose area code...</option>
                         <option value="212">212 - New York, NY</option>
                         <option value="213">213 - Los Angeles, CA</option>
                         <option value="312">312 - Chicago, IL</option>
                         <option value="305">305 - Miami, FL</option>
                         <option value="404">404 - Atlanta, GA</option>
                         <option value="415">415 - San Francisco, CA</option>
                         <option value="512">512 - Austin, TX</option>
                         <option value="617">617 - Boston, MA</option>
                         <option value="702">702 - Las Vegas, NV</option>
                         <option value="713">713 - Houston, TX</option>
                         <option value="214">214 - Dallas, TX</option>
                         <option value="215">215 - Philadelphia, PA</option>
                         <option value="216">216 - Cleveland, OH</option>
                         <option value="217">217 - Springfield, IL</option>
                         <option value="218">218 - Duluth, MN</option>
                         <option value="219">219 - Gary, IN</option>
                         <option value="220">220 - Columbus, OH</option>
                         <option value="221">221 - Pittsburgh, PA</option>
                         <option value="222">222 - Baltimore, MD</option>
                       </select>
                     </div>
                   </div>
                   <div class="col-md-6">
                     <div class="form-group mb-3">
                       <label class="form-label">Employee Name</label>
                       <input type="text" class="form-control" id="employeeName" placeholder="Enter employee name">
                     </div>
                   </div>
                </div>
                <div id="deviceDetails" class="mt-3" style="display: none;">
                  <div class="card">
                    <div class="card-body">
                      <div class="row align-items-center">
                        <div class="col-md-3">
                          <img id="deviceImage" src="" alt="Device" class="img-fluid" style="max-height: 100px;">
                        </div>
                        <div class="col-md-9">
                          <h6 id="deviceTitle">Device Details</h6>
                          <p id="deviceDescription" class="text-muted mb-2"></p>
                          <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted">MSRP:</span>
                            <span class="h6 mb-0" id="deviceMSRP">$0</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Step 2: Plan Options -->
              <div class="step-content" id="step2">
                <h6 class="mb-4">Plan Options</h6>
                <div class="row">
                  <div class="col-md-6">
                    <h6 class="mb-3">Business Plans</h6>
                    <div class="plan-options">
                      <div class="form-check plan-option mb-3">
                        <input class="form-check-input" type="radio" name="planOption" id="plan1" value="business_individual_20">
                        <label class="form-check-label" for="plan1">
                          <div class="plan-name">Business Individual Value Unlimited Talk & Text</div>
                          <div class="plan-price">$20.00/mo.</div>
                          <a href="#" class="plan-details-link">View plan details</a>
                        </label>
                      </div>
                      <div class="form-check plan-option mb-3">
                        <input class="form-check-input" type="radio" name="planOption" id="plan2" value="one_plan_tfb_25">
                        <label class="form-check-label" for="plan2">
                          <div class="plan-name">ONE Plan TFB TE</div>
                          <div class="plan-price">$25.00/mo.</div>
                          <a href="#" class="plan-details-link">View plan details</a>
                        </label>
                      </div>
                      <div class="form-check plan-option mb-3">
                        <input class="form-check-input" type="radio" name="planOption" id="plan3" value="one_plan_voice_tablet_35">
                        <label class="form-check-label" for="plan3">
                          <div class="plan-name">One Plan Voice and Tablet For Enterprise</div>
                          <div class="plan-price">$35.00/mo.</div>
                          <a href="#" class="plan-details-link">View plan details</a>
                        </label>
                      </div>
                      <div class="form-check plan-option mb-3">
                        <input class="form-check-input" type="radio" name="planOption" id="plan4" value="one_plan_voice_tablet_45">
                        <label class="form-check-label" for="plan4">
                          <div class="plan-name">One Plan Voice and Tablet For Enterprise</div>
                          <div class="plan-price">$45.00/mo.</div>
                          <a href="#" class="plan-details-link">View plan details</a>
                        </label>
                      </div>
                      <div class="form-check plan-option mb-3">
                        <input class="form-check-input" type="radio" name="planOption" id="plan5" value="one_plan_voice_tablet_55">
                        <label class="form-check-label" for="plan5">
                          <div class="plan-name">One Plan Voice and Tablet For Enterprise</div>
                          <div class="plan-price">$55.00/mo.</div>
                          <a href="#" class="plan-details-link">View plan details</a>
                        </label>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <h6 class="mb-3">Premium Plans</h6>
                    <div class="plan-options">
                      <div class="form-check plan-option mb-3">
                        <input class="form-check-input" type="radio" name="planOption" id="plan6" value="business_individual_60">
                        <label class="form-check-label" for="plan6">
                          <div class="plan-name">Business Individual Value Unlimited Talk & Text</div>
                          <div class="plan-price">$60.00/mo.</div>
                          <a href="#" class="plan-details-link">View plan details</a>
                        </label>
                      </div>
                      <div class="form-check plan-option mb-3">
                        <input class="form-check-input" type="radio" name="planOption" id="plan7" value="one_plan_tfb_65">
                        <label class="form-check-label" for="plan7">
                          <div class="plan-name">ONE Plan TFB TE</div>
                          <div class="plan-price">$65.00/mo.</div>
                          <a href="#" class="plan-details-link">View plan details</a>
                        </label>
                      </div>
                      <div class="form-check plan-option mb-3">
                        <input class="form-check-input" type="radio" name="planOption" id="plan8" value="one_plan_voice_tablet_75">
                        <label class="form-check-label" for="plan8">
                          <div class="plan-name">One Plan Voice and Tablet For Enterprise</div>
                          <div class="plan-price">$75.00/mo.</div>
                          <a href="#" class="plan-details-link">View plan details</a>
                        </label>
                      </div>
                      <div class="form-check plan-option mb-3">
                        <input class="form-check-input" type="radio" name="planOption" id="plan9" value="one_plan_voice_tablet_85">
                        <label class="form-check-label" for="plan9">
                          <div class="plan-name">One Plan Voice and Tablet For Enterprise</div>
                          <div class="plan-price">$85.00/mo.</div>
                          <a href="#" class="plan-details-link">View plan details</a>
                        </label>
                      </div>
                      <div class="form-check plan-option mb-3">
                        <input class="form-check-input" type="radio" name="planOption" id="plan10" value="one_plan_voice_tablet_95">
                        <label class="form-check-label" for="plan10">
                          <div class="plan-name">One Plan Voice and Tablet For Enterprise</div>
                          <div class="plan-price">$95.00/mo.</div>
                          <a href="#" class="plan-details-link">View plan details</a>
                        </label>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="mt-4">
                  <a href="#" class="text-primary">See our broadband facts ></a>
                </div>
              </div>

              <!-- Step 3: Device Protection -->
              <div class="step-content" id="step3">
                <h6 class="mb-4">Device Protection</h6>
                <div class="protection-options">
                  <div class="form-check protection-option mb-4">
                    <input class="form-check-input" type="radio" name="protectionOption" id="noProtection" value="none" checked>
                    <label class="form-check-label" for="noProtection">
                      <div class="protection-name">I do not want device protection for any of these lines</div>
                      <div class="protection-price">$0.00/mo.</div>
                    </label>
                  </div>
                  <div class="form-check protection-option mb-4">
                    <input class="form-check-input" type="radio" name="protectionOption" id="protection360" value="protection_360">
                    <label class="form-check-label" for="protection360">
                      <div class="protection-name">Protection 360 Tier S TE</div>
                      <div class="protection-price">$18.00/mo.</div>
                      <div class="protection-features">
                        <ul class="list-unstyled mt-2">
                          <li>✓ Screen damage protection</li>
                          <li>✓ Accidental damage coverage</li>
                          <li>✓ Theft and loss protection</li>
                          <li>✓ 24/7 tech support</li>
                        </ul>
                      </div>
                    </label>
                  </div>
                </div>
              </div>

              <!-- Step 4: Trade-in -->
              <div class="step-content" id="step4">
                <h6 class="mb-4">Trade-in</h6>
                <div class="trade-in-options">
                  <div class="form-check trade-in-option mb-4">
                    <input class="form-check-input" type="radio" name="tradeInOption" id="noTradeIn" value="no" checked>
                    <label class="form-check-label" for="noTradeIn">
                      <div class="trade-in-name">No, I don't want to trade in a device</div>
                    </label>
                  </div>
                  <div class="form-check trade-in-option mb-4">
                    <input class="form-check-input" type="radio" name="tradeInOption" id="yesTradeIn" value="yes">
                    <label class="form-check-label" for="yesTradeIn">
                      <div class="trade-in-name">Yes, I want to trade in a device</div>
                      <div class="trade-in-description text-muted">Get credit toward your new device</div>
                    </label>
                  </div>
                </div>
                <div id="tradeInDetails" class="mt-3" style="display: none;">
                  <div class="card">
                    <div class="card-body">
                      <h6 class="card-title">Trade-in Device Details</h6>
                      <div class="row">
                        <div class="col-md-6">
                          <div class="form-group mb-3">
                            <label class="form-label">Device Brand</label>
                            <select class="form-select" id="tradeInBrand">
                              <option value="">Select brand...</option>
                              <option value="apple">Apple</option>
                              <option value="samsung">Samsung</option>
                              <option value="google">Google</option>
                              <option value="motorola">Motorola</option>
                              <option value="lg">LG</option>
                              <option value="other">Other</option>
                            </select>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="form-group mb-3">
                            <label class="form-label">Device Model</label>
                            <input type="text" class="form-control" id="tradeInModel" placeholder="Enter device model">
                          </div>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-md-6">
                          <div class="form-group mb-3">
                            <label class="form-label">Device Condition</label>
                            <select class="form-select" id="tradeInCondition">
                              <option value="">Select condition...</option>
                              <option value="excellent">Excellent - Like new</option>
                              <option value="good">Good - Minor wear</option>
                              <option value="fair">Fair - Some damage</option>
                              <option value="poor">Poor - Significant damage</option>
                            </select>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="form-group mb-3">
                            <label class="form-label">Estimated Value</label>
                            <div class="input-group">
                              <span class="input-group-text">$</span>
                              <input type="text" class="form-control" id="tradeInValue" placeholder="0.00" readonly>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Step 5: Summary -->
              <div class="step-content" id="step5">
                <h6 class="mb-4">Summary</h6>
                <div class="summary-container">
                  <div class="row">
                    <div class="col-md-8">
                      <div class="summary-item mb-3">
                        <div class="d-flex justify-content-between align-items-start">
                          <div>
                            <h6 class="mb-1" id="summaryDeviceTitle">Device</h6>
                            <div class="text-muted small" id="summaryDeviceDetails">No device selected</div>
                          </div>
                          <div class="text-end">
                            <div class="h6 mb-0" id="summaryDevicePrice">$0.00</div>
                            <div class="text-muted small" id="summaryDeviceMSRP">MSRP: $0.00</div>
                          </div>
                        </div>
                      </div>
                      <div class="summary-item mb-3">
                        <div class="d-flex justify-content-between align-items-start">
                          <div>
                            <h6 class="mb-1" id="summaryPlanTitle">Plan</h6>
                            <div class="text-muted small" id="summaryPlanDetails">No plan selected</div>
                          </div>
                          <div class="text-end">
                            <div class="h6 mb-0" id="summaryPlanPrice">$0.00/mo.</div>
                          </div>
                        </div>
                      </div>
                      <div class="summary-item mb-3">
                        <div class="d-flex justify-content-between align-items-start">
                          <div>
                            <h6 class="mb-1" id="summaryProtectionTitle">Device Protection</h6>
                            <div class="text-muted small" id="summaryProtectionDetails">No protection selected</div>
                          </div>
                          <div class="text-end">
                            <div class="h6 mb-0" id="summaryProtectionPrice">$0.00/mo.</div>
                          </div>
                        </div>
                      </div>
                      <div class="summary-item mb-3" id="summaryTradeInItem" style="display: none;">
                        <div class="d-flex justify-content-between align-items-start">
                          <div>
                            <h6 class="mb-1" id="summaryTradeInTitle">Trade-in Credit</h6>
                            <div class="text-muted small" id="summaryTradeInDetails">No trade-in selected</div>
                          </div>
                          <div class="text-end">
                            <div class="h6 mb-0 text-success" id="summaryTradeInValue">-$0.00</div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="card bg-light">
                        <div class="card-body">
                          <h6 class="card-title">Pricing Summary</h6>
                          <hr>
                          <div class="d-flex justify-content-between mb-2">
                            <span>Device (24 mo.):</span>
                            <span id="summaryDeviceMonthly">$0.00/mo.</span>
                          </div>
                          <div class="d-flex justify-content-between mb-2">
                            <span>Plan:</span>
                            <span id="summaryPlanMonthly">$0.00/mo.</span>
                          </div>
                          <div class="d-flex justify-content-between mb-2">
                            <span>Protection:</span>
                            <span id="summaryProtectionMonthly">$0.00/mo.</span>
                          </div>
                          <hr>
                          <div class="d-flex justify-content-between mb-2">
                            <strong>Total Monthly:</strong>
                            <strong class="text-primary" id="summaryTotalMonthly">$0.00/mo.</strong>
                          </div>
                          <div class="d-flex justify-content-between mb-2">
                            <span>Due Now:</span>
                            <span id="summaryDueNow">$0.00</span>
                          </div>
                          <div class="text-muted small mt-3">
                            <p class="mb-1">• 24-month device payment plan</p>
                            <p class="mb-1">• 0% APR for well-qualified buyers</p>
                            <p class="mb-0">• Service required</p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Step 6: Checkout -->
              <div class="step-content" id="step6">
                <h6 class="mb-4">Checkout</h6>
                <div class="row">
                  <div class="col-md-8">
                    <div class="card mb-4">
                      <div class="card-body">
                        <h6 class="card-title mb-3">Order Summary</h6>
                        <div id="checkoutOrderSummary">
                          <!-- Order summary will be populated here -->
                        </div>
                      </div>
                    </div>
                    <div class="card">
                      <div class="card-body">
                        <h6 class="card-title mb-3">Payment Method</h6>
                        <div class="form-check">
                          <input class="form-check-input" type="radio" name="paymentMethod" id="creditCardCheckout" checked>
                          <label class="form-check-label" for="creditCardCheckout">
                            <strong>Credit Card ending in 1234</strong>
                            <div class="text-muted small">Visa •••• 1234</div>
                          </label>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="card bg-light">
                      <div class="card-body">
                        <h6 class="card-title">Billing Summary</h6>
                        <hr>
                        <div class="d-flex justify-content-between mb-2">
                          <span>Subtotal:</span>
                          <span id="checkoutSubtotalFinal">$0.00</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                          <span>Taxes & Fees:</span>
                          <span id="checkoutTaxesFinal">$0.00</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-3">
                          <strong>Total:</strong>
                          <strong class="text-primary" id="checkoutTotalFinal">$0.00</strong>
                        </div>
                        <div class="text-muted small">
                          <p class="mb-2">• Device will be shipped within 2-3 business days</p>
                          <p class="mb-2">• Service will be activated upon device activation</p>
                          <p class="mb-0">• You will receive confirmation via SMS and email</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="prevStepBtn" style="display: none;">Back</button>
            <button type="button" class="btn btn-primary" id="nextStepBtn">Next</button>
                                    <button type="button" class="btn btn-success" id="completeAddLineOrderBtn" style="display: none;">Complete Order</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Chatbot UI -->
    <button class="chatbot-toggle" id="chatbotToggle">
        💬
    </button>

    <div class="chatbot-container" id="chatbotContainer">
        <div class="chatbot-header">
            <h6 class="chatbot-title">T-Mobile Assistant</h6>
            <button class="chatbot-close" id="chatbotClose">×</button>
        </div>
        <div class="chatbot-messages" id="chatbotMessages">
            <div class="message system">
                Welcome! I can help you manage your lines and services. Try commands like:
            </div>
            <div class="chatbot-suggestions">
                <span class="suggestion-chip" data-suggestion="Add a service">Add a service</span>
                <span class="suggestion-chip" data-suggestion="Suspend a line">Suspend a line</span>
                <span class="suggestion-chip" data-suggestion="Restore all suspended lines">Restore lines</span>
                <span class="suggestion-chip" data-suggestion="Add a new line to this account">Add A Line</span>
                <span class="suggestion-chip" data-suggestion="Mirror an existing line">Mirror a Line</span>
                <span class="suggestion-chip" data-suggestion="Upgrade existing lines">Upgrade Lines</span>
            </div>
        </div>
        <div class="chatbot-input-area">
            <div class="chatbot-input-group">
                <textarea class="chatbot-input" id="chatbotInput" placeholder="Type your message..." rows="1"></textarea>
                <button class="chatbot-send" id="chatbotSend">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22,2 15,22 11,13 2,9"></polygon>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
      // Helper to show modal with custom title and message
      function showComingSoonModal(title, message) {
        document.getElementById('comingSoonModalLabel').textContent = title;
        document.getElementById('comingSoonModalBody').textContent = message;
        var modal = new bootstrap.Modal(document.getElementById('comingSoonModal'));
        modal.show();
      }

      // Add a Line Modal Functionality
      let currentStep = 1;
      let orderData = {
        device: {},
        plan: {},
        protection: {},
        tradeIn: {},
        summary: {}
      };

      // Device data
      const deviceData = {
        iphone: {
          'iPhone 16 Pro': {
            colors: ['Black Titanium', 'White Titanium', 'Natural Titanium', 'Blue Titanium'],
            storage: ['128GB', '256GB', '512GB', '1TB'],
            msrp: 999.99,
            image: 'https://via.placeholder.com/100x100?text=iPhone+16+Pro'
          },
          'iPhone 16': {
            colors: ['Black', 'White', 'Blue', 'Green', 'Pink'],
            storage: ['128GB', '256GB', '512GB'],
            msrp: 799.99,
            image: 'https://via.placeholder.com/100x100?text=iPhone+16'
          }
        },
        samsung: {
          'Galaxy S24 Ultra': {
            colors: ['Titanium Black', 'Titanium Gray', 'Titanium Violet', 'Titanium Yellow'],
            storage: ['256GB', '512GB', '1TB'],
            msrp: 1299.99,
            image: 'https://via.placeholder.com/100x100?text=Galaxy+S24+Ultra'
          },
          'Galaxy S24+': {
            colors: ['Onyx Black', 'Marble Gray', 'Cobalt Violet', 'Amber Yellow'],
            storage: ['256GB', '512GB'],
            msrp: 999.99,
            image: 'https://via.placeholder.com/100x100?text=Galaxy+S24+'
          }
        }
      };

      // Plan data
      const planData = {
        'business_individual_20': { name: 'Business Individual Value Unlimited Talk & Text', price: 20.00 },
        'one_plan_tfb_25': { name: 'ONE Plan TFB TE', price: 25.00 },
        'one_plan_voice_tablet_35': { name: 'One Plan Voice and Tablet For Enterprise', price: 35.00 },
        'one_plan_voice_tablet_45': { name: 'One Plan Voice and Tablet For Enterprise', price: 45.00 },
        'one_plan_voice_tablet_55': { name: 'One Plan Voice and Tablet For Enterprise', price: 55.00 },
        'business_individual_60': { name: 'Business Individual Value Unlimited Talk & Text', price: 60.00 },
        'one_plan_tfb_65': { name: 'ONE Plan TFB TE', price: 65.00 },
        'one_plan_voice_tablet_75': { name: 'One Plan Voice and Tablet For Enterprise', price: 75.00 },
        'one_plan_voice_tablet_85': { name: 'One Plan Voice and Tablet For Enterprise', price: 85.00 },
        'one_plan_voice_tablet_95': { name: 'One Plan Voice and Tablet For Enterprise', price: 95.00 }
      };

      // Protection data
      const protectionData = {
        'none': { name: 'No Protection', price: 0.00 },
        'protection_360': { name: 'Protection 360 Tier S TE', price: 18.00 }
      };

              document.getElementById('addLineBtn').addEventListener('click', function() {
          console.log('Add Line button clicked');
          openAddLineModal();
        });
        
        // Debug: Check if elements exist when page loads
        document.addEventListener('DOMContentLoaded', function() {
          console.log('Page loaded, checking elements...');
          console.log('Add Line button:', document.getElementById('addLineBtn'));
          console.log('Add Line modal:', document.getElementById('addLineModal'));
          console.log('Device type select:', document.getElementById('deviceType'));
          console.log('Device model select:', document.getElementById('deviceModel'));
          console.log('Device color select:', document.getElementById('deviceColor'));
          console.log('Device storage select:', document.getElementById('deviceStorage'));
          console.log('Device data available:', deviceData);
          console.log('Plan data available:', planData);
          console.log('Protection data available:', protectionData);
          console.log('Bootstrap available:', typeof bootstrap !== 'undefined');
          console.log('Bootstrap Modal available:', typeof bootstrap !== 'undefined' && typeof bootstrap.Modal !== 'undefined');
        });

        // Test function for Add Line modal dropdowns
        window.testAddLineDropdowns = function() {
          console.log('=== Testing Add Line Dropdowns ===');
          console.log('Device data:', deviceData);
          console.log('Plan data:', planData);
          console.log('Protection data:', protectionData);
          
          // Test populating dropdowns
          populateModalDropdowns();
          
          console.log('Dropdown population test completed');
        };

        // Test function to check if data is available
        window.checkAddLineData = function() {
          console.log('=== Checking Add Line Data ===');
          console.log('deviceData available:', typeof deviceData !== 'undefined');
          console.log('deviceData keys:', deviceData ? Object.keys(deviceData) : 'undefined');
          console.log('planData available:', typeof planData !== 'undefined');
          console.log('planData keys:', planData ? Object.keys(planData) : 'undefined');
          console.log('protectionData available:', typeof protectionData !== 'undefined');
          console.log('protectionData keys:', protectionData ? Object.keys(protectionData) : 'undefined');
          
          // Check if elements exist
          console.log('deviceType element:', document.getElementById('deviceType'));
          console.log('deviceModel element:', document.getElementById('deviceModel'));
          console.log('deviceColor element:', document.getElementById('deviceColor'));
          console.log('deviceStorage element:', document.getElementById('deviceStorage'));
        };
        
        // Test function to check plan validation specifically
        window.testPlanValidation = function() {
          console.log('=== Testing Plan Validation ===');
          console.log('Current step:', currentStep);
          
          // Check if we're on step 2
          if (currentStep === 2) {
            console.log('On step 2, checking plan validation...');
            const planValid = document.querySelector('input[name="planOption"]:checked');
            console.log('Plan validation result:', planValid);
            console.log('Selected plan value:', planValid ? planValid.value : 'none');
            
            // Check all plan radio buttons
            const allPlanRadios = document.querySelectorAll('input[name="planOption"]');
            console.log('All plan radio buttons:', allPlanRadios);
            allPlanRadios.forEach((radio, index) => {
              console.log(`Plan radio ${index + 1}:`, radio.id, 'checked:', radio.checked, 'value:', radio.value);
            });
          } else {
            console.log('Not on step 2, current step is:', currentStep);
          }
        };
        
        // Test function to check upgrade modal specifically
        window.testUpgradeModal = function() {
          console.log('=== Testing Upgrade Modal ===');
          console.log('Upgrade current step:', upgradeCurrentStep);
          console.log('Upgrade data:', upgradeData);
          
          // Check upgrade type selection
          const upgradeType = document.querySelector('input[name="upgradeType"]:checked');
          console.log('Selected upgrade type:', upgradeType ? upgradeType.value : 'none');
          
          // Check plan selection if applicable
          if (upgradeType && (upgradeType.value === 'plan' || upgradeType.value === 'full')) {
            const planValid = document.querySelector('input[name="upgradePlanOption"]:checked');
            console.log('Upgrade plan validation result:', planValid);
            console.log('Selected upgrade plan:', planValid ? planValid.value : 'none');
            
            // Check all upgrade plan radio buttons
            const allUpgradePlanRadios = document.querySelectorAll('input[name="upgradePlanOption"]');
            console.log('All upgrade plan radio buttons:', allUpgradePlanRadios);
            allUpgradePlanRadios.forEach((radio, index) => {
              console.log(`Upgrade plan radio ${index + 1}:`, radio.id, 'checked:', radio.checked, 'value:', radio.value);
            });
          }
          
          // Check step content visibility
          console.log('=== Upgrade Step Content Status ===');
          document.querySelectorAll('#upgradeModal .step-content').forEach((content, index) => {
            const stepNumber = index + 1;
            const isActive = content.classList.contains('active');
            const computedDisplay = window.getComputedStyle(content).display;
            console.log(`Upgrade Step ${stepNumber} (${content.id}): active=${isActive}, display=${computedDisplay}`);
          });
        };
        
        // Test function to check chatbot functionality
        window.testChatbot = function() {
            console.log('=== Testing Chatbot ===');
            console.log('Chatbot toggle element:', document.getElementById('chatbotToggle'));
            console.log('Chatbot container element:', document.getElementById('chatbotContainer'));
            console.log('Chatbot close button element:', document.getElementById('chatbotClose'));
            console.log('Chatbot open state:', chatbotOpen);
            console.log('Chatbot container display:', document.getElementById('chatbotContainer').style.display);
            console.log('Chatbot container computed display:', window.getComputedStyle(document.getElementById('chatbotContainer')).display);
            
            // Check header visibility
            const header = document.querySelector('.chatbot-header');
            if (header) {
                console.log('Chatbot header element:', header);
                console.log('Header computed styles:', {
                    display: window.getComputedStyle(header).display,
                    visibility: window.getComputedStyle(header).visibility,
                    opacity: window.getComputedStyle(header).opacity,
                    height: window.getComputedStyle(header).height,
                    background: window.getComputedStyle(header).background,
                    zIndex: window.getComputedStyle(header).zIndex
                });
                console.log('Header bounding rect:', header.getBoundingClientRect());
            } else {
                console.error('Chatbot header not found!');
            }
            
            // Check close button visibility
            const closeBtn = document.getElementById('chatbotClose');
            if (closeBtn) {
                console.log('Close button computed styles:', {
                    display: window.getComputedStyle(closeBtn).display,
                    visibility: window.getComputedStyle(closeBtn).visibility,
                    opacity: window.getComputedStyle(closeBtn).opacity,
                    width: window.getComputedStyle(closeBtn).width,
                    height: window.getComputedStyle(closeBtn).height,
                    background: window.getComputedStyle(closeBtn).background
                });
                console.log('Close button bounding rect:', closeBtn.getBoundingClientRect());
            } else {
                console.error('Chatbot close button not found!');
            }
        };
        
        // Test function to check add line modal specifically
        window.testAddLineModal = function() {
          console.log('=== Testing Add Line Modal ===');
          console.log('Current step:', currentStep);
          console.log('Order data:', orderData);
          
          // Check step content visibility
          console.log('=== Add Line Step Content Status ===');
          document.querySelectorAll('#addLineModal .step-content').forEach((content, index) => {
            const stepNumber = index + 1;
            const isActive = content.classList.contains('active');
            const computedDisplay = window.getComputedStyle(content).display;
            console.log(`Add Line Step ${stepNumber} (${content.id}): active=${isActive}, display=${computedDisplay}`);
          });
          
          // Check progress steps
          console.log('=== Add Line Progress Steps Status ===');
          document.querySelectorAll('#addLineModal .progress-step').forEach((step, index) => {
            const stepNumber = index + 1;
            const isActive = step.classList.contains('active');
            const isCompleted = step.classList.contains('completed');
            console.log(`Progress Step ${stepNumber}: active=${isActive}, completed=${isCompleted}`);
          });
          
          // Check if form fields are visible
          console.log('=== Add Line Form Fields Status ===');
          const deviceType = document.getElementById('deviceType');
          const deviceModel = document.getElementById('deviceModel');
          const deviceColor = document.getElementById('deviceColor');
          const deviceStorage = document.getElementById('deviceStorage');
          const areaCode = document.getElementById('areaCode');
          const employeeName = document.getElementById('employeeName');
          
          console.log('Device Type field:', deviceType ? 'exists' : 'missing', deviceType ? deviceType.style.display : 'N/A');
          console.log('Device Model field:', deviceModel ? 'exists' : 'missing', deviceModel ? deviceModel.style.display : 'N/A');
          console.log('Device Color field:', deviceColor ? 'exists' : 'missing', deviceColor ? deviceColor.style.display : 'N/A');
          console.log('Device Storage field:', deviceStorage ? 'exists' : 'missing', deviceStorage ? deviceStorage.style.display : 'N/A');
          console.log('Area Code field:', areaCode ? 'exists' : 'missing', areaCode ? areaCode.style.display : 'N/A');
          console.log('Employee Name field:', employeeName ? 'exists' : 'missing', employeeName ? employeeName.style.display : 'N/A');
        };
      
              // Function to open Add Line modal (can be called from button or URL parameter)
        function openAddLineModal() {
          console.log('Opening Add Line modal...');
          
          // Reset modal state
          currentStep = 1;
          orderData = {
            device: {},
            plan: {},
            protection: {},
            tradeIn: {},
            summary: {}
          };
          
          // Reset form fields
          resetModalForm();
          
          // Show modal
          var modalElement = document.getElementById('addLineModal');
          console.log('Modal element:', modalElement);
          
          if (modalElement) {
            var modal = new bootstrap.Modal(modalElement);
            console.log('Bootstrap modal instance:', modal);
            modal.show();
            
            // Populate dropdowns and update UI after modal opens
            setTimeout(() => {
              console.log('Modal opened, populating dropdowns...');
              console.log('Initial currentStep:', currentStep);
              
              // Populate all dropdowns with data
              populateModalDropdowns();
              
              // Update progress and buttons
              updateProgress();
              updateModalButtons();
              
              console.log('Modal initialization complete');
              console.log('Final currentStep:', currentStep);
            }, 100);
                    } else {
            console.error('Modal element not found!');
          }
        }
      
      // Function to open Add Service modal
      function openAddServiceModal() {
        console.log('Opening Add Service modal...');
        
        // Reset form fields
        document.getElementById('serviceSelect').value = '';
        document.getElementById('serviceDetails').style.display = 'none';
        document.getElementById('nextBtn').disabled = true;
        
        // Show modal
        var modalElement = document.getElementById('addServiceModal');
        if (modalElement) {
          var modal = new bootstrap.Modal(modalElement);
          modal.show();
          
          // Add event listener for service selection
          const serviceSelect = document.getElementById('serviceSelect');
          const nextBtn = document.getElementById('nextBtn');
          const serviceDetails = document.getElementById('serviceDetails');
          
          serviceSelect.addEventListener('change', function() {
            const selectedValue = this.value;
            if (selectedValue) {
              nextBtn.disabled = false;
              showServiceDetails(selectedValue);
            } else {
              nextBtn.disabled = true;
              serviceDetails.style.display = 'none';
            }
          });
          
          // Add event listener for Next button
          nextBtn.addEventListener('click', function() {
            const selectedValue = serviceSelect.value;
            if (selectedValue) {
              // Close this modal and open line selection modal
              var addServiceModal = bootstrap.Modal.getInstance(document.getElementById('addServiceModal'));
              addServiceModal.hide();
              
              // Open line selection modal (you'll need to create this)
              openLineSelectionModal(selectedValue);
            }
          });
        } else {
          console.error('Add Service modal element not found!');
        }
      }
      
      // Function to show service details
      function showServiceDetails(serviceValue) {
        const serviceDetails = document.getElementById('serviceDetails');
        const serviceDetailsContent = document.getElementById('serviceDetailsContent');
        
        let serviceInfo = '';
        switch(serviceValue) {
          case '1day':
            serviceInfo = `
              <div class="alert alert-info">
                <h6>1 Day International Pass</h6>
                <p class="mb-1"><strong>Price:</strong> $1.00</p>
                <p class="mb-1"><strong>Data:</strong> 512MB</p>
                <p class="mb-1"><strong>Duration:</strong> 1 day</p>
                <p class="mb-0"><strong>Coverage:</strong> 210+ countries</p>
              </div>
            `;
            break;
          case '10day':
            serviceInfo = `
              <div class="alert alert-info">
                <h6>10 Day International Pass</h6>
                <p class="mb-1"><strong>Price:</strong> $35.00</p>
                <p class="mb-1"><strong>Data:</strong> 5GB</p>
                <p class="mb-1"><strong>Duration:</strong> 10 days</p>
                <p class="mb-0"><strong>Coverage:</strong> 210+ countries</p>
              </div>
            `;
            break;
          case '30day':
            serviceInfo = `
              <div class="alert alert-info">
                <h6>30 Day International Pass</h6>
                <p class="mb-1"><strong>Price:</strong> $50.00</p>
                <p class="mb-1"><strong>Data:</strong> 15GB</p>
                <p class="mb-1"><strong>Duration:</strong> 30 days</p>
                <p class="mb-0"><strong>Coverage:</strong> 210+ countries</p>
              </div>
            `;
            break;
        }
        
        serviceDetailsContent.innerHTML = serviceInfo;
        serviceDetails.style.display = 'block';
      }
      
      // Function to open line selection modal
      function openLineSelectionModal(selectedService) {
        // For now, just show a message - you can enhance this later
        showComingSoonModal(
          'Line Selection', 
          `You selected the ${selectedService} service. Line selection functionality will be implemented next.`
        );
      }
      
      // Check for URL parameters and handle accordingly
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('add_line') === 'true') {
        // Wait for page to fully load before opening modal
        setTimeout(() => {
          openAddLineModal();
          // Remove the parameter from URL without reloading
          const newUrl = window.location.pathname;
          window.history.replaceState({}, document.title, newUrl);
        }, 500);
      } else if (urlParams.get('line_added') === 'true') {
        // Show success message for newly added line
        setTimeout(() => {
          showComingSoonModal(
            'Welcome Back!', 
            'Your new line has been successfully added to this account. You can see it in the lines table below.'
          );
          // Remove the parameter from URL without reloading
          const newUrl = window.location.pathname;
          window.history.replaceState({}, document.title, newUrl);
        }, 1000);
      }

      // Mirror Line Modal Functionality
      let mirrorCurrentStep = 1;
      let selectedLineToMirror = null;

      // Function to open Mirror Line modal
      function openMirrorLineModal(preSelectedLineData = null) {
        // Reset modal state
        mirrorCurrentStep = 1;
        selectedLineToMirror = null;
        
        // Reset form fields
        document.getElementById('lineToMirrorSelect').value = '';
        document.getElementById('newEmployeeName').value = '';
        document.getElementById('newLineName').value = '';
        document.getElementById('selectedLineDetails').style.display = 'none';
        document.getElementById('mirrorStep2').style.display = 'none';
        
        // Show step 1
        document.getElementById('mirrorStep1').style.display = 'block';
        
        // Update buttons
        document.getElementById('mirrorBackBtn').style.display = 'none';
        document.getElementById('mirrorNextBtn').style.display = 'inline-block';
        document.getElementById('mirrorCompleteBtn').style.display = 'none';
        document.getElementById('mirrorNextBtn').disabled = true;
        
        // Show modal
        var modalElement = document.getElementById('mirrorLineModal');
        if (modalElement) {
          var modal = new bootstrap.Modal(modalElement);
          modal.show();
          
          // If pre-selected line data is provided, automatically select it
          if (preSelectedLineData) {
            setTimeout(() => {
              // Find and select the line in the dropdown
              const selectElement = document.getElementById('lineToMirrorSelect');
              const option = Array.from(selectElement.options).find(opt => opt.value == preSelectedLineData.id);
              
              if (option) {
                selectElement.value = preSelectedLineData.id;
                
                // Set the selected line data
                selectedLineToMirror = {
                  id: preSelectedLineData.id,
                  lineName: preSelectedLineData.line_name,
                  employeeName: preSelectedLineData.employee_name,
                  msdn: preSelectedLineData.msdn,
                  deviceModel: preSelectedLineData.device_model,
                  deviceColor: preSelectedLineData.device_color,
                  deviceStorage: preSelectedLineData.device_storage,
                  planName: preSelectedLineData.plan_name,
                  protectionName: preSelectedLineData.protection_name
                };
                
                // Show line details
                document.getElementById('mirrorLineName').textContent = selectedLineToMirror.lineName;
                document.getElementById('mirrorEmployeeName').textContent = selectedLineToMirror.employeeName;
                document.getElementById('mirrorMsdn').textContent = selectedLineToMirror.msdn;
                
                // Show device, plan, and protection details
                const deviceText = selectedLineToMirror.deviceModel ? 
                  `${selectedLineToMirror.deviceModel} - ${selectedLineToMirror.deviceColor}, ${selectedLineToMirror.deviceStorage}` : 
                  'Not specified';
                document.getElementById('mirrorDevice').textContent = deviceText;
                document.getElementById('mirrorPlan').textContent = selectedLineToMirror.planName || 'Not specified';
                document.getElementById('mirrorProtection').textContent = selectedLineToMirror.protectionName || 'Not specified';
                
                document.getElementById('selectedLineDetails').style.display = 'block';
                
                // Enable Next button
                document.getElementById('mirrorNextBtn').disabled = false;
                
                // Trigger change event to ensure all handlers are called
                selectElement.dispatchEvent(new Event('change'));
              }
            }, 100);
          }
        }
      }

      // Handle line selection in mirror modal
      document.getElementById('lineToMirrorSelect').addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (this.value) {
          // Get line data from the server to get device, plan, and protection info
          fetch(`/api/lines/${this.value}/details/`)
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                selectedLineToMirror = {
                  id: this.value,
                  lineName: selectedOption.dataset.lineName,
                  employeeName: selectedOption.dataset.employeeName,
                  msdn: selectedOption.dataset.msdn,
                  deviceModel: data.line.device_model,
                  deviceColor: data.line.device_color,
                  deviceStorage: data.line.device_storage,
                  planName: data.line.plan_name,
                  protectionName: data.line.protection_name
                };
                
                // Show line details
                document.getElementById('mirrorLineName').textContent = selectedLineToMirror.lineName;
                document.getElementById('mirrorEmployeeName').textContent = selectedLineToMirror.employeeName;
                document.getElementById('mirrorMsdn').textContent = selectedLineToMirror.msdn;
                
                // Show device, plan, and protection details
                const deviceText = selectedLineToMirror.deviceModel ? 
                  `${selectedLineToMirror.deviceModel} - ${selectedLineToMirror.deviceColor}, ${selectedLineToMirror.deviceStorage}` : 
                  'Not specified';
                document.getElementById('mirrorDevice').textContent = deviceText;
                document.getElementById('mirrorPlan').textContent = selectedLineToMirror.planName || 'Not specified';
                document.getElementById('mirrorProtection').textContent = selectedLineToMirror.protectionName || 'Not specified';
                
                document.getElementById('selectedLineDetails').style.display = 'block';
                
                // Enable Next button
                document.getElementById('mirrorNextBtn').disabled = false;
              }
            })
            .catch(error => {
              console.error('Error fetching line details:', error);
              // Fallback to basic info without device/plan/protection
              selectedLineToMirror = {
                id: this.value,
                lineName: selectedOption.dataset.lineName,
                employeeName: selectedOption.dataset.employeeName,
                msdn: selectedOption.dataset.msdn
              };
              
              document.getElementById('mirrorLineName').textContent = selectedLineToMirror.lineName;
              document.getElementById('mirrorEmployeeName').textContent = selectedLineToMirror.employeeName;
              document.getElementById('mirrorMsdn').textContent = selectedLineToMirror.msdn;
              document.getElementById('mirrorDevice').textContent = 'Not specified';
              document.getElementById('mirrorPlan').textContent = 'Not specified';
              document.getElementById('mirrorProtection').textContent = 'Not specified';
              document.getElementById('selectedLineDetails').style.display = 'block';
              document.getElementById('mirrorNextBtn').disabled = false;
            });
        } else {
          selectedLineToMirror = null;
          document.getElementById('selectedLineDetails').style.display = 'none';
          document.getElementById('mirrorNextBtn').disabled = true;
        }
      });

      // Handle Next button in mirror modal
      document.getElementById('mirrorNextBtn').addEventListener('click', function() {
        if (mirrorCurrentStep === 1) {
          // Move to step 2
          mirrorCurrentStep = 2;
          document.getElementById('mirrorStep1').style.display = 'none';
          document.getElementById('mirrorStep2').style.display = 'block';
          document.getElementById('mirrorBackBtn').style.display = 'inline-block';
          document.getElementById('mirrorNextBtn').style.display = 'none';
          document.getElementById('mirrorCompleteBtn').style.display = 'inline-block';
          
          // Copy mirrored settings to step 2
          document.getElementById('mirrorDevice2').textContent = document.getElementById('mirrorDevice').textContent;
          document.getElementById('mirrorPlan2').textContent = document.getElementById('mirrorPlan').textContent;
          document.getElementById('mirrorProtection2').textContent = document.getElementById('mirrorProtection').textContent;
          
          // Auto-generate line name
          const existingLines = document.querySelectorAll('#lineToMirrorSelect option');
          const newLineNumber = existingLines.length + 1; // Add 1 to get the next line number
          document.getElementById('newLineName').value = `Line ${newLineNumber}`;
        }
      });

      // Handle Back button in mirror modal
      document.getElementById('mirrorBackBtn').addEventListener('click', function() {
        if (mirrorCurrentStep === 2) {
          // Move back to step 1
          mirrorCurrentStep = 1;
          document.getElementById('mirrorStep1').style.display = 'block';
          document.getElementById('mirrorStep2').style.display = 'none';
          document.getElementById('mirrorBackBtn').style.display = 'none';
          document.getElementById('mirrorNextBtn').style.display = 'inline-block';
          document.getElementById('mirrorCompleteBtn').style.display = 'none';
        }
      });

      // Handle Complete button in mirror modal
      document.getElementById('mirrorCompleteBtn').addEventListener('click', async function() {
        const employeeName = document.getElementById('newEmployeeName').value.trim();
        const lineName = document.getElementById('newLineName').value.trim();
        
        if (!employeeName) {
          alert('Please enter an employee name.');
          return;
        }
        
        if (!selectedLineToMirror) {
          alert('Please select a line to mirror.');
          return;
        }
        
        // Disable button and show loading state
        const completeBtn = this;
        const originalText = completeBtn.textContent;
        completeBtn.disabled = true;
        completeBtn.textContent = 'Creating...';
        
        try {
          // Make API call to create the mirrored line
          const response = await fetch('/api/lines/mirror/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              account_id: currentAccountId,
              line_to_mirror_id: selectedLineToMirror.id,
              new_employee_name: employeeName,
              new_line_name: lineName
            })
          });
          
          const data = await response.json();
          
          if (response.ok && data.success) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('mirrorLineModal'));
            modal.hide();
            
            // Show success message
            showComingSoonModal(
              'Line Mirrored Successfully!', 
              `Your new line "${data.line.line_name}" for ${data.line.employee_name} has been created with the same settings as ${data.line.mirrored_from.line_name}.`
            );
            
            // Refresh the page to show the new line
            setTimeout(() => {
              window.location.reload();
            }, 2000);
          } else {
            alert(`Error: ${data.error || 'Failed to create mirrored line'}`);
          }
        } catch (error) {
          console.error('Error creating mirrored line:', error);
          alert('Error: Failed to create mirrored line. Please try again.');
        } finally {
          // Re-enable button
          completeBtn.disabled = false;
          completeBtn.textContent = originalText;
        }
      });
      document.getElementById('upgradeBtn').addEventListener('click', function() {
        const selectedLines = getSelectedLines();
        if (selectedLines.length === 0) {
          alert('Please select at least one line to upgrade.');
          return;
        }
        openUpgradeModal();
      });
      const addServicesBtn = document.getElementById('addServicesBtn');
      if (addServicesBtn) {
        addServicesBtn.addEventListener('click', function() {
          console.log('Add Services button clicked');
          const modalElement = document.getElementById('addServiceModal');
          if (modalElement) {
            var modal = new bootstrap.Modal(modalElement);
            modal.show();
          } else {
            console.error('Modal element not found');
          }
        });
      } else {
        console.error('Add Services button not found');
      }
      document.getElementById('suspendBtn').addEventListener('click', function() {
        const selectedLines = getSelectedLines();
        if (selectedLines.length === 0) {
          alert('Please select at least one line to suspend.');
          return;
        }
        
        const lineIds = selectedLines.map(line => line.id);
        const lineNames = selectedLines.map(line => line.name).join(', ');
        
        if (confirm(`Are you sure you want to suspend the following line(s)?\n\n${lineNames}\n\nThis will temporarily disable service for these lines.`)) {
          suspendLines(lineIds);
        }
      });
      
      document.getElementById('restoreBtn').addEventListener('click', function() {
        const selectedLines = getSelectedLines();
        if (selectedLines.length === 0) {
          alert('Please select at least one line to restore.');
          return;
        }
        
        const lineIds = selectedLines.map(line => line.id);
        const lineNames = selectedLines.map(line => line.name).join(', ');
        
        if (confirm(`Are you sure you want to restore the following line(s)?\n\n${lineNames}\n\nThis will re-enable service for these lines.`)) {
          restoreLines(lineIds);
        }
      });
      document.getElementById('simSwapBtn').addEventListener('click', function() {
        showComingSoonModal('SIM SWAP', 'This feature is coming soon.');
      });

      // Global variables for services and selected lines
      let availableServices = [];
      let selectedLines = [];
      
      // Load services on page load
      loadAvailableServices();
      
      async function loadAvailableServices() {
        try {
          const response = await fetch('/api/services/');
          const data = await response.json();
          availableServices = data.services;
          populateServiceSelect();
        } catch (error) {
          console.error('Error loading services:', error);
        }
      }
      
      function populateServiceSelect() {
        const serviceSelect = document.getElementById('serviceSelect');
        serviceSelect.innerHTML = '<option value="">Choose an option...</option>';
        
        availableServices.forEach(service => {
          const option = document.createElement('option');
          option.value = service.id;
          option.textContent = `$${service.price}: ${service.name}`;
          serviceSelect.appendChild(option);
        });
      }

      // Add Service Modal functionality
      document.getElementById('serviceSelect').addEventListener('change', function() {
        const nextBtn = document.getElementById('nextBtn');
        const serviceDetails = document.getElementById('serviceDetails');
        const serviceDetailsContent = document.getElementById('serviceDetailsContent');
        
        nextBtn.disabled = !this.value;
        
        if (this.value) {
          serviceDetails.style.display = 'block';
          
          const selectedService = availableServices.find(service => service.id == this.value);
          if (selectedService) {
            let detailsHtml = `<h6 class="text-primary mb-2">${selectedService.name}</h6>`;
            detailsHtml += `<p class="text-muted mb-3">${selectedService.description}</p>`;
          detailsHtml += '<ul class="list-unstyled">';
            detailsHtml += `<li class="mb-2"><i class="text-success me-2">✓</i>Duration: ${selectedService.duration_days} days</li>`;
            if (selectedService.data_allowance_mb) {
              detailsHtml += `<li class="mb-2"><i class="text-success me-2">✓</i>Data Allowance: ${selectedService.data_allowance_mb}MB</li>`;
            }
            selectedService.features.forEach(feature => {
              detailsHtml += `<li class="mb-2"><i class="text-success me-2">✓</i>${feature}</li>`;
          });
          detailsHtml += '</ul>';
          
          serviceDetailsContent.innerHTML = detailsHtml;
          }
        } else {
          serviceDetails.style.display = 'none';
        }
      });

      document.getElementById('nextBtn').addEventListener('click', function() {
        const selectedServiceId = document.getElementById('serviceSelect').value;
        if (selectedServiceId) {
          // Get selected lines before proceeding
          selectedLines = getSelectedLines();
          
          if (selectedLines.length === 0) {
            alert('Please select at least one line to add the service to.');
            return;
          }
          
          // Populate checkout modal with selected service
          populateCheckoutModal(selectedServiceId);
          
          // Close add service modal and open checkout modal
          var addServiceModal = bootstrap.Modal.getInstance(document.getElementById('addServiceModal'));
          addServiceModal.hide();
          
          setTimeout(() => {
            var checkoutModal = new bootstrap.Modal(document.getElementById('checkoutModal'));
            checkoutModal.show();
          }, 300);
        }
      });

      function getSelectedLines() {
        const checkboxes = document.querySelectorAll('.line-checkbox:checked');
        return Array.from(checkboxes).map(checkbox => ({
          id: parseInt(checkbox.dataset.lineId),
          name: checkbox.closest('tr').querySelector('td:nth-child(2)').textContent,
          msdn: checkbox.closest('tr').querySelector('td:nth-child(3)').textContent
        }));
      }

      function populateCheckoutModal(serviceId) {
        const selectedService = availableServices.find(service => service.id == serviceId);
        if (!selectedService) return;

        const taxes = Math.round(selectedService.price * 0.08 * 100) / 100; // 8% tax
        const total = selectedService.price + taxes;

        // Create features summary
        let features = `${selectedService.duration_days} days`;
        if (selectedService.data_allowance_mb) {
          features += ` • ${selectedService.data_allowance_mb}MB data`;
        }
        features += ` • ${selectedService.service_type.replace('_', ' ')}`;

        document.getElementById('checkoutServiceTitle').textContent = selectedService.name;
        document.getElementById('checkoutServiceFeatures').textContent = features;
        document.getElementById('checkoutServicePrice').textContent = `$${selectedService.price}`;
        document.getElementById('checkoutSubtotal').textContent = `$${selectedService.price.toFixed(2)}`;
        document.getElementById('checkoutTaxes').textContent = `$${taxes.toFixed(2)}`;
        document.getElementById('checkoutTotal').textContent = `$${total.toFixed(2)}`;
        
        // Store selected service ID for order completion
        document.getElementById('checkoutModal').dataset.serviceId = serviceId;
      }

      // Back button in checkout modal
      document.getElementById('backToServiceBtn').addEventListener('click', function() {
        var checkoutModal = bootstrap.Modal.getInstance(document.getElementById('checkoutModal'));
        checkoutModal.hide();
        
        setTimeout(() => {
          var addServiceModal = new bootstrap.Modal(document.getElementById('addServiceModal'));
          addServiceModal.show();
        }, 300);
      });

      // Complete order button
      document.getElementById('completeOrderBtn').addEventListener('click', async function() {
        const serviceId = document.getElementById('checkoutModal').dataset.serviceId;
        const lineIds = selectedLines.map(line => line.id);
        
        if (!serviceId || lineIds.length === 0) {
          alert('Error: Missing service or line selection');
          return;
        }
        
        // Disable button and show loading state
        const completeBtn = this;
        completeBtn.disabled = true;
        completeBtn.textContent = 'Processing...';
        
        try {
          const response = await fetch('/api/services/add/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              service_id: parseInt(serviceId),
              line_ids: lineIds,
              payment_method: 'Credit Card'
            })
          });
          
          const data = await response.json();
          
          if (response.ok && data.success) {
            // Success
            const serviceName = data.service_details.name;
            const totalAmount = `$${data.service_details.total_amount.toFixed(2)}`;
            const linesCount = data.services_added.length;
        
        showComingSoonModal(
              'Service Successfully Added!', 
              `${serviceName} has been successfully added to ${linesCount} line(s) for ${totalAmount}. The service is now active and you will receive confirmation via SMS and email.`
        );
            
        var checkoutModal = bootstrap.Modal.getInstance(document.getElementById('checkoutModal'));
        checkoutModal.hide();
        
        // Reset search and filters after successful order
        setTimeout(() => {
          resetSearchAndFilters();
              // Optionally refresh the page to show updated data
              // window.location.reload();
        }, 500);
            
          } else {
            // Error from API
            alert(`Error: ${data.error || 'Failed to add service'}`);
          }
          
        } catch (error) {
          console.error('Error adding service:', error);
          alert('Error: Failed to process order. Please try again.');
        }
        
        // Re-enable button
        completeBtn.disabled = false;
        completeBtn.textContent = 'Complete Order';
      });

      // Enhanced search functionality
      const searchInput = document.getElementById('linesSearchInput');
      const clearSearchBtn = document.getElementById('clearSearchBtn');
      const searchSuggestions = document.getElementById('searchSuggestions');
      const filterBtns = document.querySelectorAll('.filter-btn');
      let currentFilter = 'all';
      
      // Search input functionality
      searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        
        // Show/hide clear button
        clearSearchBtn.style.display = searchTerm ? 'block' : 'none';
        
        // Show/hide suggestions
        if (searchTerm.length > 0) {
          showSuggestions(searchTerm);
        } else {
          searchSuggestions.style.display = 'none';
        }
        
        // Filter table
        filterTable(searchTerm, currentFilter);
      });
      
      // Clear search button
      clearSearchBtn.addEventListener('click', function() {
        searchInput.value = '';
        searchInput.focus();
        clearSearchBtn.style.display = 'none';
        searchSuggestions.style.display = 'none';
        filterTable('', currentFilter);
      });
      
      // Search suggestions
      searchInput.addEventListener('focus', function() {
        if (this.value.length > 0) {
          showSuggestions(this.value);
        }
      });
      
      // Hide suggestions when clicking outside
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.search-container')) {
          searchSuggestions.style.display = 'none';
        }
      });
      
      // Filter buttons
      filterBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          // Update active state
          filterBtns.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          
          // Update current filter
          currentFilter = this.dataset.filter;
          
          // Re-filter table
          filterTable(searchInput.value.toLowerCase().trim(), currentFilter);
        });
      });
      
      // Suggestion click handler
      searchSuggestions.addEventListener('click', function(e) {
        if (e.target.classList.contains('suggestion-item')) {
          const searchValue = e.target.dataset.search;
          searchInput.value = e.target.textContent;
          searchInput.focus();
          searchSuggestions.style.display = 'none';
          filterTable(searchValue, currentFilter);
        }
      });
      
      function showSuggestions(searchTerm) {
        const suggestions = searchSuggestions.querySelectorAll('.suggestion-item');
        let hasVisibleSuggestions = false;
        
        suggestions.forEach(suggestion => {
          const text = suggestion.textContent.toLowerCase();
          if (text.includes(searchTerm)) {
            suggestion.style.display = 'block';
            hasVisibleSuggestions = true;
          } else {
            suggestion.style.display = 'none';
          }
        });
        
        searchSuggestions.style.display = hasVisibleSuggestions ? 'block' : 'none';
      }
      
      function filterTable(searchTerm, filter) {
        const tableBody = document.querySelector('.lines-table tbody');
        const rows = tableBody.querySelectorAll('tr');
        const searchResults = document.getElementById('searchResults');
        let visibleCount = 0;
        
        rows.forEach(row => {
          const cells = row.querySelectorAll('td');
          const status = cells[7]?.textContent.toLowerCase() || '';
          
          // Check if row matches filter
          let matchesFilter = true;
          if (filter === 'active' && status !== 'active') {
            matchesFilter = false;
          } else if (filter === 'suspended' && status !== 'suspended') {
            matchesFilter = false;
          }
          
          // Check if row matches search term
          const searchableText = [
            cells[1]?.textContent || '', // Line Name
            cells[2]?.textContent || '', // MSDN
            cells[3]?.textContent || '', // Employee Name
            cells[4]?.textContent || '', // Employee Number
            cells[5]?.textContent || '', // Added on
            cells[6]?.textContent || '', // Payment Due
            cells[7]?.textContent || ''  // Status
          ].join(' ').toLowerCase();
          
          const matchesSearch = !searchTerm || searchableText.includes(searchTerm);
          
          if (matchesFilter && matchesSearch) {
            row.style.display = '';
            visibleCount++;
          } else {
            row.style.display = 'none';
          }
        });
        
        // Update search results text
        updateSearchResultsText(visibleCount, searchTerm, filter);
      }
      
      function updateSearchResultsText(visibleCount, searchTerm, filter) {
        const searchResults = document.getElementById('searchResults');
        let text = '';
        
        if (searchTerm && filter !== 'all') {
          text = `${visibleCount} lines found (filtered by "${filter}")`;
        } else if (searchTerm) {
          text = visibleCount === 1 ? '1 line found' : `${visibleCount} lines found`;
        } else if (filter !== 'all') {
          text = `${visibleCount} ${filter} lines`;
        } else {
          text = 'Showing all lines';
        }
        
        if (visibleCount === 0) {
          text = 'No lines found';
        }
        
        searchResults.textContent = text;
      }

      // Checkbox and button management
      const actionButtons = document.querySelectorAll('.lines-action-btns .btn');
      const tableCheckboxes = document.querySelectorAll('.line-checkbox');
      const headerCheckbox = document.querySelector('.lines-table thead .form-check-input');
      
      // Function to update button states
      function updateButtonStates() {
        const checkedBoxes = document.querySelectorAll('.line-checkbox:checked');
        const hasCheckedBoxes = checkedBoxes.length > 0;
        
        actionButtons.forEach(button => {
          button.disabled = !hasCheckedBoxes;
        });
        
        // Update button text to show selection count
        if (hasCheckedBoxes) {
          const count = checkedBoxes.length;
          const countText = count === 1 ? '1 line selected' : `${count} lines selected`;
          
          // Update button text to show selection
          actionButtons.forEach(button => {
            const originalText = button.getAttribute('data-original-text') || button.textContent;
            if (!button.getAttribute('data-original-text')) {
              button.setAttribute('data-original-text', originalText);
            }
            button.textContent = `${originalText} (${count})`;
          });
        } else {
          // Restore original button text
          actionButtons.forEach(button => {
            const originalText = button.getAttribute('data-original-text');
            if (originalText) {
              button.textContent = originalText;
            }
          });
        }
      }
      
      // Function to reset search and filters
      function resetSearchAndFilters() {
        // Clear search input
        const searchInput = document.getElementById('linesSearchInput');
        if (searchInput) {
          searchInput.value = '';
        }
        
        // Clear search button
        const clearSearchBtn = document.getElementById('clearSearchBtn');
        if (clearSearchBtn) {
          clearSearchBtn.style.display = 'none';
        }
        
        // Hide search suggestions
        const searchSuggestions = document.getElementById('searchSuggestions');
        if (searchSuggestions) {
          searchSuggestions.style.display = 'none';
        }
        
        // Reset filter buttons to "All"
        const filterBtns = document.querySelectorAll('.filter-btn');
        filterBtns.forEach(btn => {
          btn.classList.remove('active');
          if (btn.dataset.filter === 'all') {
            btn.classList.add('active');
          }
        });
        
        // Reset current filter
        currentFilter = 'all';
        
        // Show all lines
        filterTable('', 'all');
        
        // Uncheck all checkboxes
        const allCheckboxes = document.querySelectorAll('.lines-table .form-check-input');
        allCheckboxes.forEach(checkbox => {
          checkbox.checked = false;
        });
        
        // Update button states
        updateButtonStates();
        
        console.log('Search and filters reset after order completion');
      }
      
      // Function to suspend lines
      async function suspendLines(lineIds) {
        try {
          const response = await fetch('/api/lines/suspend/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              line_ids: lineIds
            })
          });
          
          const data = await response.json();
          
          if (response.ok && data.success) {
            // Success - show confirmation
            showComingSoonModal(
              'Lines Suspended Successfully!', 
              `${data.message}\n\nSuspended lines:\n${data.suspended_lines.map(line => `• ${line.line_name} (${line.msdn})`).join('\n')}`
            );
            
            // Refresh the page to show updated status
            setTimeout(() => {
              window.location.reload();
            }, 2000);
          } else {
            // Error from API
            alert(`Error: ${data.error || 'Failed to suspend lines'}`);
          }
          
        } catch (error) {
          console.error('Error suspending lines:', error);
          alert('Error: Failed to suspend lines. Please try again.');
        }
      }
      
      // Function to restore lines
      async function restoreLines(lineIds) {
        try {
          const response = await fetch('/api/lines/restore/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              line_ids: lineIds
            })
          });
          
          const data = await response.json();
          
          if (response.ok && data.success) {
            // Success - show confirmation
            showComingSoonModal(
              'Lines Restored Successfully!', 
              `${data.message}\n\nRestored lines:\n${data.restored_lines.map(line => `• ${line.line_name} (${line.msdn})`).join('\n')}`
            );
            
            // Refresh the page to show updated status
            setTimeout(() => {
              window.location.reload();
            }, 2000);
          } else {
            // Error from API
            alert(`Error: ${data.error || 'Failed to restore lines'}`);
          }
          
        } catch (error) {
          console.error('Error restoring lines:', error);
          alert('Error: Failed to restore lines. Please try again.');
        }
      }
      
      // Handle individual row checkboxes
      tableCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          updateButtonStates();
        });
      });
      
      // Handle header checkbox (select all)
      if (headerCheckbox) {
        headerCheckbox.addEventListener('change', function() {
          const isChecked = this.checked;
          const visibleCheckboxes = document.querySelectorAll('.line-checkbox');
          visibleCheckboxes.forEach(checkbox => {
            // Only check boxes for visible rows
            if (checkbox.closest('tr').style.display !== 'none') {
            checkbox.checked = isChecked;
            }
          });
          updateButtonStates();
        });
      }
    </script>

    <!-- Chatbot UI -->
    <script>
        // Chatbot functionality
        const chatbotToggle = document.getElementById('chatbotToggle');
        const chatbotContainer = document.getElementById('chatbotContainer');
        const chatbotClose = document.getElementById('chatbotClose');
        const chatbotInput = document.getElementById('chatbotInput');
        const chatbotSend = document.getElementById('chatbotSend');
        const chatbotMessages = document.getElementById('chatbotMessages');
        
        let chatbotOpen = false;
        let currentAccountId = parseInt('{{ account.id }}');
        let conversationHistory = [];
        let currentEditingLineId = null;

        // Toggle chatbot
        chatbotToggle.addEventListener('click', function() {
            console.log('Chatbot toggle clicked, current state:', chatbotOpen);
            chatbotOpen = !chatbotOpen;
            chatbotContainer.style.display = chatbotOpen ? 'flex' : 'none';
            console.log('Chatbot toggled to:', chatbotOpen, 'display:', chatbotContainer.style.display);
            
            if (chatbotOpen) {
                chatbotInput.focus();
                // Keep chat open - don't close after each message
                
                // Debug: Check if header and close button are visible after opening
                setTimeout(() => {
                    console.log('=== Chatbot opened, checking elements ===');
                    const header = document.querySelector('.chatbot-header');
                    const closeBtn = document.getElementById('chatbotClose');
                    const container = document.getElementById('chatbotContainer');
                    
                    console.log('Container display:', container.style.display);
                    console.log('Header found:', !!header);
                    console.log('Close button found:', !!closeBtn);
                    
                    if (header) {
                        console.log('Header display:', window.getComputedStyle(header).display);
                        console.log('Header height:', window.getComputedStyle(header).height);
                    }
                    
                    if (closeBtn) {
                        console.log('Close button display:', window.getComputedStyle(closeBtn).display);
                        console.log('Close button dimensions:', {
                            width: window.getComputedStyle(closeBtn).width,
                            height: window.getComputedStyle(closeBtn).height
                        });
                    }
                }, 100);
            }
        });

        chatbotClose.addEventListener('click', function() {
            console.log('Chatbot close button clicked');
            chatbotOpen = false;
            chatbotContainer.style.display = 'none';
            console.log('Chatbot closed, chatbotOpen:', chatbotOpen);
        });

        // Auto-resize textarea
        chatbotInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // Send message on Enter
        chatbotInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        chatbotSend.addEventListener('click', sendMessage);

        // Handle suggestion clicks
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('suggestion-chip')) {
                const suggestion = e.target.dataset.suggestion;
                chatbotInput.value = suggestion;
                sendMessage();
            }
        });

        async function sendMessage() {
            const message = chatbotInput.value.trim();
            if (!message) return;

            // Add user message to chat
            addMessage(message, 'user');
            chatbotInput.value = '';
            chatbotInput.style.height = 'auto';

            // Store message in conversation history
            conversationHistory.push({ role: 'user', content: message });

            // Show typing indicator
            const typingIndicator = addTypingIndicator();

            try {
                const response = await fetch('/api/chatbot/message/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        account_id: currentAccountId,
                        conversation_history: conversationHistory
                    })
                });

                const data = await response.json();
                
                // Remove typing indicator
                typingIndicator.remove();

                if (response.ok) {
                    // Add assistant response
                    addMessage(data.response, 'assistant');
                    
                    // Store assistant response in conversation history
                    conversationHistory.push({ role: 'assistant', content: data.response });
                    
                    // If there was a tool action, show system message
                    if (data.tool_result) {
                        addMessage(data.tool_result, 'system');
                        conversationHistory.push({ role: 'system', content: data.tool_result });
                    }
                    
                    // Handle modal triggers
                    if (data.trigger_modal === 'add_line') {
                        // Close chatbot and open Add Line modal
                        setTimeout(() => {
                            chatbotOpen = false;
                            chatbotContainer.style.display = 'none';
                            openAddLineModal();
                        }, 1000);
                    } else if (data.trigger_modal === 'mirror_line') {
                        // Close chatbot and open Mirror Line modal
                        setTimeout(() => {
                            chatbotOpen = false;
                            chatbotContainer.style.display = 'none';
                            openMirrorLineModal(data.line_to_mirror_data);
                        }, 1000);
                    } else if (data.trigger_modal === 'add_service') {
                        // Close chatbot and open Add Service modal
                        setTimeout(() => {
                            chatbotOpen = false;
                            chatbotContainer.style.display = 'none';
                            openAddServiceModal();
                        }, 1000);
                    } else if (data.trigger_modal === 'upgrade_line') {
                        // Close chatbot and open Upgrade Line modal
                        setTimeout(() => {
                            chatbotOpen = false;
                            chatbotContainer.style.display = 'none';
                            openUpgradeModal();
                        }, 1000);
                    }
                    
                    // Keep chat open - don't refresh page automatically
                    // Only refresh if explicitly needed
                    if (data.refresh_needed) {
                        // Show a subtle notification instead of full page refresh
                        showRefreshNotification();
                    }
                } else {
                    addMessage('Sorry, I encountered an error. Please try again.', 'assistant');
                }
            } catch (error) {
                console.error('Chatbot error:', error);
                typingIndicator.remove();
                addMessage('Sorry, I encountered an error. Please try again.', 'assistant');
            }
        }

        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.textContent = text;
            chatbotMessages.appendChild(messageDiv);
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
            return messageDiv;
        }

                function addTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.innerHTML = `
                <span>Assistant is typing</span>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            chatbotMessages.appendChild(typingDiv);
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
            return typingDiv;
        }

        function showRefreshNotification() {
            // Create a subtle notification instead of full page refresh
            const notification = document.createElement('div');
            notification.className = 'message system';
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span>🔄</span>
                    <span>Data updated! You can continue chatting or refresh the page to see changes.</span>
                    <button onclick="window.location.reload()" style="background: var(--tmobile-magenta); color: white; border: none; border-radius: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.8rem; cursor: pointer;">Refresh</button>
                </div>
            `;
            chatbotMessages.appendChild(notification);
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
            
            // Auto-remove notification after 10 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 10000);
        }

        // Upgrade Modal Functionality
        let upgradeCurrentStep = 1;
        let upgradeData = {
          selectedLines: [],
          upgradeType: 'device',
          device: {},
          plan: {},
          summary: {}
        };

        // Function to open Upgrade modal
        function openUpgradeModal() {
          // Reset modal state
          upgradeCurrentStep = 1;
          upgradeData = {
            selectedLines: [],
            upgradeType: 'device',
            device: {},
            plan: {},
            summary: {}
          };
          
          // Reset form fields
          resetUpgradeModalForm();
          
          // Populate lines table
          populateUpgradeLinesTable();
          
          // Show modal
          var modalElement = document.getElementById('upgradeModal');
          if (modalElement) {
            var modal = new bootstrap.Modal(modalElement);
            modal.show();
            
            // Update progress and buttons after modal is shown
            setTimeout(() => {
              updateUpgradeProgress();
              updateUpgradeModalButtons();
            }, 100);
          }
        }

        // Function to reset upgrade modal form
        function resetUpgradeModalForm() {
          // Reset all form fields
          document.getElementById('upgradeDeviceType').value = '';
          document.getElementById('upgradeDeviceModel').value = '';
          document.getElementById('upgradeDeviceColor').value = '';
          document.getElementById('upgradeDeviceStorage').value = '';
          document.getElementById('upgradeDeviceQuantity').value = '1';
          
          // Disable dependent fields
          document.getElementById('upgradeDeviceModel').disabled = true;
          document.getElementById('upgradeDeviceColor').disabled = true;
          document.getElementById('upgradeDeviceStorage').disabled = true;
          
          // Hide device details
          document.getElementById('upgradeDeviceDetails').style.display = 'none';
          
          // Reset plan selection
          document.querySelectorAll('input[name="upgradePlanOption"]').forEach(radio => {
            radio.checked = false;
          });
          
          // Reset upgrade type selection
          document.getElementById('deviceUpgrade').checked = true;
        }

        // Function to populate upgrade lines table
        function populateUpgradeLinesTable() {
          const tableBody = document.getElementById('upgradeLinesTableBody');
          const selectedLines = getSelectedLines();
          
          tableBody.innerHTML = '';
          
          selectedLines.forEach(line => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td><input type="checkbox" class="form-check-input upgrade-line-checkbox" value="${line.id}" data-line-name="${line.name}" data-msdn="${line.msdn}"></td>
              <td>${line.name}</td>
              <td>${line.name.split(' ')[0]}</td>
              <td>Current Device</td>
              <td>Current Plan</td>
              <td><span class="badge bg-success">Active</span></td>
            `;
            tableBody.appendChild(row);
          });
          
          // Update selected count
          updateUpgradeSelectedCount();
          
          // Add event listeners to checkboxes
          document.querySelectorAll('.upgrade-line-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', updateUpgradeSelectedCount);
          });
          
          // Add event listener to select all checkbox
          document.getElementById('upgradeSelectAll').addEventListener('change', function() {
            const isChecked = this.checked;
            document.querySelectorAll('.upgrade-line-checkbox').forEach(checkbox => {
              checkbox.checked = isChecked;
            });
            updateUpgradeSelectedCount();
          });
        }

        // Function to update upgrade selected count
        function updateUpgradeSelectedCount() {
          const selectedCheckboxes = document.querySelectorAll('.upgrade-line-checkbox:checked');
          const count = selectedCheckboxes.length;
          document.getElementById('upgradeSelectedCount').textContent = count;
          
          // Update upgrade data
          upgradeData.selectedLines = Array.from(selectedCheckboxes).map(checkbox => ({
            id: parseInt(checkbox.value),
            name: checkbox.dataset.lineName,
            msdn: checkbox.dataset.msdn
          }));
          
          // Enable/disable next button
          updateUpgradeModalButtons();
        }

        // Function to update upgrade progress
        function updateUpgradeProgress() {
          console.log('updateUpgradeProgress called with upgradeCurrentStep:', upgradeCurrentStep);
          
          // Update progress steps
          document.querySelectorAll('#upgradeModal .progress-step').forEach((step, index) => {
            const stepNumber = index + 1;
            step.classList.remove('active', 'completed');
            
            if (stepNumber < upgradeCurrentStep) {
              step.classList.add('completed');
            } else if (stepNumber === upgradeCurrentStep) {
              step.classList.add('active');
            }
          });
          
          // Show current step content
          console.log('=== Updating Upgrade Step Content Visibility ===');
          document.querySelectorAll('#upgradeModal .step-content').forEach((content, index) => {
            const stepNumber = index + 1;
            const shouldBeActive = stepNumber === upgradeCurrentStep;
            console.log(`Upgrade Step content ${stepNumber}:`, content.id, 'should be active:', shouldBeActive);
            console.log(`Upgrade Step content ${stepNumber} current classes:`, content.className);
            
            content.classList.remove('active');
            console.log(`Upgrade Step content ${stepNumber} after removing active:`, content.className);
            
            if (shouldBeActive) {
              content.classList.add('active');
              console.log(`Activated upgrade step content: ${content.id}`);
              console.log(`Upgrade Step content ${stepNumber} final classes:`, content.className);
              console.log(`Upgrade Step content ${stepNumber} computed display:`, window.getComputedStyle(content).display);
            }
          });
          
          // Final check of all upgrade step content visibility
          console.log('=== Final Upgrade Step Content Status ===');
          document.querySelectorAll('#upgradeModal .step-content').forEach((content, index) => {
            const stepNumber = index + 1;
            const isActive = content.classList.contains('active');
            const computedDisplay = window.getComputedStyle(content).display;
            console.log(`Final - Upgrade Step ${stepNumber} (${content.id}): active=${isActive}, display=${computedDisplay}`);
          });
        }

        // Function to update upgrade modal buttons
        function updateUpgradeModalButtons() {
          const prevBtn = document.getElementById('upgradePrevBtn');
          const nextBtn = document.getElementById('upgradeNextBtn');
          const completeBtn = document.getElementById('upgradeCompleteBtn');
          
          // Show/hide buttons based on current step
          prevBtn.style.display = upgradeCurrentStep > 1 ? 'block' : 'none';
          nextBtn.style.display = upgradeCurrentStep < 6 ? 'block' : 'none';
          completeBtn.style.display = upgradeCurrentStep === 6 ? 'block' : 'none';
          
          // Update button text
          if (upgradeCurrentStep === 5) {
            nextBtn.textContent = 'Proceed to Checkout';
          } else if (upgradeCurrentStep === 6) {
            nextBtn.style.display = 'none';
          } else {
            nextBtn.textContent = 'Next';
          }
          
          // Enable/disable next button based on validation
          nextBtn.disabled = !validateUpgradeCurrentStep();
        }

        // Function to validate upgrade current step
        function validateUpgradeCurrentStep() {
          console.log('validateUpgradeCurrentStep called for step:', upgradeCurrentStep);
          
          switch (upgradeCurrentStep) {
            case 1: // Select lines
              const linesValid = upgradeData.selectedLines.length > 0;
              console.log('Upgrade Step 1 validation result:', linesValid, 'Selected lines:', upgradeData.selectedLines.length);
              return linesValid;
            case 2: // Upgrade type
              const upgradeTypeValid = document.querySelector('input[name="upgradeType"]:checked');
              console.log('Upgrade Step 2 validation result:', upgradeTypeValid, 'Selected upgrade type:', upgradeTypeValid ? upgradeTypeValid.value : 'none');
              return upgradeTypeValid;
            case 3: // New device (if applicable)
              const upgradeType = document.querySelector('input[name="upgradeType"]:checked')?.value;
              console.log('Upgrade Step 3 - upgrade type:', upgradeType);
              
              if (upgradeType === 'device' || upgradeType === 'full') {
                const deviceValid = document.getElementById('upgradeDeviceType').value && 
                       document.getElementById('upgradeDeviceModel').value && 
                       document.getElementById('upgradeDeviceColor').value && 
                       document.getElementById('upgradeDeviceStorage').value;
                console.log('Upgrade Step 3 validation result (device required):', deviceValid);
                return deviceValid;
              }
              console.log('Upgrade Step 3 validation result (device not required):', true);
              return true;
            case 4: // New plan (if applicable)
              const planUpgradeType = document.querySelector('input[name="upgradeType"]:checked')?.value;
              console.log('Upgrade Step 4 - upgrade type:', planUpgradeType);
              
              if (planUpgradeType === 'plan' || planUpgradeType === 'full') {
                const planValid = document.querySelector('input[name="upgradePlanOption"]:checked');
                console.log('Upgrade Step 4 validation result (plan required):', planValid, 'Selected plan:', planValid ? planValid.value : 'none');
                return planValid;
              }
              console.log('Upgrade Step 4 validation result (plan not required):', true);
              return true;
            case 5: // Summary
              console.log('Upgrade Step 5 validation result:', true);
              return true;
            case 6: // Checkout
              console.log('Upgrade Step 6 validation result:', true);
              return true;
            default:
              console.log('Upgrade Step validation result (default):', false);
              return false;
          }
        }

        // Function to save upgrade current step data
        function saveUpgradeCurrentStepData() {
          switch (upgradeCurrentStep) {
            case 1:
              // Lines are already saved in updateUpgradeSelectedCount
              break;
            case 2:
              const selectedUpgradeType = document.querySelector('input[name="upgradeType"]:checked');
              if (selectedUpgradeType) {
                upgradeData.upgradeType = selectedUpgradeType.value;
              }
              break;
            case 3:
              const upgradeType = document.getElementById('upgradeDeviceType').value;
              const upgradeDeviceModel = document.getElementById('upgradeDeviceModel').value;
              const upgradeDeviceColor = document.getElementById('upgradeDeviceColor').value;
              const upgradeDeviceStorage = document.getElementById('upgradeDeviceStorage').value;
              const upgradeDeviceQuantity = parseInt(document.getElementById('upgradeDeviceQuantity').value);
              
              if (upgradeType && upgradeDeviceModel && upgradeDeviceColor && upgradeDeviceStorage) {
                const deviceInfo = deviceData[upgradeType][upgradeDeviceModel];
                upgradeData.device = {
                  type: upgradeType,
                  model: upgradeDeviceModel,
                  color: upgradeDeviceColor,
                  storage: upgradeDeviceStorage,
                  quantity: upgradeDeviceQuantity,
                  msrp: deviceInfo.msrp,
                  image: deviceInfo.image
                };
              }
              break;
            case 4:
              const selectedPlan = document.querySelector('input[name="upgradePlanOption"]:checked');
              if (selectedPlan) {
                const planKey = selectedPlan.value;
                upgradeData.plan = {
                  key: planKey,
                  ...planData[planKey]
                };
              }
              break;
          }
        }

        // Function to update upgrade summary
        function updateUpgradeSummary() {
          // Update lines summary
          const linesSummary = document.getElementById('upgradeSummaryLines');
          let linesHtml = '';
          
          upgradeData.selectedLines.forEach(line => {
            linesHtml += `
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span>${line.name} (${line.msdn})</span>
                <span class="badge bg-primary">Selected</span>
              </div>
            `;
          });
          linesSummary.innerHTML = linesHtml;
          
          // Update upgrade details summary
          const detailsSummary = document.getElementById('upgradeSummaryDetails');
          let detailsHtml = '';
          
          if (upgradeData.upgradeType === 'device' || upgradeData.upgradeType === 'full') {
            detailsHtml += `
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span>Device:</span>
                <span>${upgradeData.device.model} - ${upgradeData.device.color}, ${upgradeData.device.storage}</span>
              </div>
            `;
          }
          
          if (upgradeData.upgradeType === 'plan' || upgradeData.upgradeType === 'full') {
            detailsHtml += `
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span>Plan:</span>
                <span>${upgradeData.plan.name}</span>
              </div>
            `;
          }
          
          detailsSummary.innerHTML = detailsHtml;
          
          // Update pricing summary
          const deviceMonthly = upgradeData.device.msrp ? (upgradeData.device.msrp * upgradeData.device.quantity) / 24 : 0;
          const planChange = upgradeData.plan.price || 0;
          const totalChange = deviceMonthly + planChange;
          
          document.getElementById('upgradeSummaryDeviceMonthly').textContent = `$${deviceMonthly.toFixed(2)}/mo.`;
          document.getElementById('upgradeSummaryPlanChange').textContent = `$${planChange.toFixed(2)}/mo.`;
          document.getElementById('upgradeSummaryTotalChange').textContent = `$${totalChange.toFixed(2)}/mo.`;
          document.getElementById('upgradeSummaryDueNow').textContent = `$${deviceMonthly.toFixed(2)}`;
          
          // Store summary data
          upgradeData.summary = {
            deviceMonthly,
            planChange,
            totalChange,
            dueNow: deviceMonthly
          };
        }

        // Function to update upgrade checkout
        function updateUpgradeCheckout() {
          // Populate checkout summary
          const checkoutSummary = document.getElementById('upgradeCheckoutSummary');
          let summaryHTML = '';
          
          if (upgradeData.device.model) {
            summaryHTML += `
              <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                  <h6 class="mb-1">${upgradeData.device.model} (${upgradeData.device.quantity})</h6>
                  <div class="text-muted small">${upgradeData.device.color}, ${upgradeData.device.storage}</div>
                </div>
                <div class="text-end">
                  <span class="h6 text-primary">$${((upgradeData.device.msrp * upgradeData.device.quantity) / 24).toFixed(2)}/mo.</span>
                </div>
              </div>
            `;
          }
          
          if (upgradeData.plan.name) {
            summaryHTML += `
              <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                  <h6 class="mb-1">${upgradeData.plan.name}</h6>
                </div>
                <div class="text-end">
                  <span class="h6 text-primary">$${upgradeData.plan.price.toFixed(2)}/mo.</span>
                </div>
              </div>
            `;
          }
          
          checkoutSummary.innerHTML = summaryHTML;
          
          // Update checkout totals
          const subtotal = upgradeData.summary.dueNow;
          const taxes = Math.round(subtotal * 0.08 * 100) / 100; // 8% tax
          const total = subtotal + taxes;
          
          document.getElementById('upgradeCheckoutSubtotal').textContent = `$${subtotal.toFixed(2)}`;
          document.getElementById('upgradeCheckoutTaxes').textContent = `$${taxes.toFixed(2)}`;
          document.getElementById('upgradeCheckoutTotal').textContent = `$${total.toFixed(2)}`;
        }

        // Event listeners for upgrade modal functionality
        document.getElementById('upgradeNextBtn').addEventListener('click', function() {
          console.log('Upgrade Next button clicked. Current step:', upgradeCurrentStep);
          console.log('Validation result:', validateUpgradeCurrentStep());
          
          if (validateUpgradeCurrentStep()) {
            console.log('Upgrade validation passed, saving current step data...');
            saveUpgradeCurrentStepData();
            console.log('Upgrade data saved:', upgradeData);
            
            const previousStep = upgradeCurrentStep;
            upgradeCurrentStep++;
            console.log(`Upgrade step incremented from ${previousStep} to ${upgradeCurrentStep}`);
            
            console.log('About to call updateUpgradeProgress...');
            updateUpgradeProgress();
            console.log('updateUpgradeProgress completed');
            
            console.log('About to call updateUpgradeModalButtons...');
            updateUpgradeModalButtons();
            console.log('updateUpgradeModalButtons completed');
            
            if (upgradeCurrentStep === 5) {
              console.log('Moving to upgrade summary step');
              updateUpgradeSummary();
            } else if (upgradeCurrentStep === 6) {
              console.log('Moving to upgrade checkout step');
              updateUpgradeCheckout();
            }
            
            // Debug: Check what step content is currently visible
            console.log('=== Upgrade Step Content Visibility Check ===');
            document.querySelectorAll('#upgradeModal .step-content').forEach((content, index) => {
              const stepNumber = index + 1;
              const isActive = content.classList.contains('active');
              const computedDisplay = window.getComputedStyle(content).display;
              console.log(`Upgrade Step ${stepNumber} (${content.id}): active=${isActive}, display=${computedDisplay}`);
            });
          } else {
            console.log('Upgrade validation failed for step:', upgradeCurrentStep);
          }
        });

        document.getElementById('upgradePrevBtn').addEventListener('click', function() {
          if (upgradeCurrentStep > 1) {
            upgradeCurrentStep--;
            updateUpgradeProgress();
            updateUpgradeModalButtons();
          }
        });

        document.getElementById('upgradeCompleteBtn').addEventListener('click', async function() {
          // Disable button and show loading state
          const completeBtn = this;
          completeBtn.disabled = true;
          completeBtn.textContent = 'Processing...';
          
          try {
            // Simulate API call for upgrade
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Success - close modal and show confirmation
            const modal = bootstrap.Modal.getInstance(document.getElementById('upgradeModal'));
            modal.hide();
            
            setTimeout(() => {
              showComingSoonModal(
                'Upgrade Completed Successfully!', 
                `Your upgrade has been processed successfully!\n\nUpgraded Lines:\n${upgradeData.selectedLines.map(line => `• ${line.name} (${line.msdn})`).join('\n')}\n\nUpgrade Type: ${upgradeData.upgradeType.charAt(0).toUpperCase() + upgradeData.upgradeType.slice(1)}\n\nYou will receive confirmation via SMS and email. New devices will be shipped within 2-3 business days.`
              );
            }, 300);
            
          } catch (error) {
            console.error('Error processing upgrade:', error);
            alert('Error: Failed to process upgrade. Please try again.');
          }
          
          // Re-enable button
          completeBtn.disabled = false;
          completeBtn.textContent = 'Complete Upgrade';
        });

        // Upgrade device selection event listeners
        document.getElementById('upgradeDeviceType').addEventListener('change', function() {
          const deviceType = this.value;
          const deviceModelSelect = document.getElementById('upgradeDeviceModel');
          const deviceColorSelect = document.getElementById('upgradeDeviceColor');
          const deviceStorageSelect = document.getElementById('upgradeDeviceStorage');
          
          // Reset dependent fields
          deviceModelSelect.innerHTML = '<option value="">Select device type first...</option>';
          deviceColorSelect.innerHTML = '<option value="">Select model first...</option>';
          deviceStorageSelect.innerHTML = '<option value="">Select model first...</option>';
          deviceColorSelect.disabled = true;
          deviceStorageSelect.disabled = true;
          
          if (deviceType && deviceData[deviceType]) {
            deviceModelSelect.disabled = false;
            Object.keys(deviceData[deviceType]).forEach(model => {
              const option = document.createElement('option');
              option.value = model;
              option.textContent = model;
              deviceModelSelect.appendChild(option);
            });
          } else {
            deviceModelSelect.disabled = true;
          }
          
          updateUpgradeModalButtons();
        });

        document.getElementById('upgradeDeviceModel').addEventListener('change', function() {
          const deviceType = document.getElementById('upgradeDeviceType').value;
          const deviceModel = this.value;
          const deviceColorSelect = document.getElementById('upgradeDeviceColor');
          const deviceStorageSelect = document.getElementById('upgradeDeviceStorage');
          
          // Reset dependent fields
          deviceColorSelect.innerHTML = '<option value="">Select model first...</option>';
          deviceStorageSelect.innerHTML = '<option value="">Select model first...</option>';
          deviceColorSelect.disabled = true;
          deviceStorageSelect.disabled = true;
          
          if (deviceType && deviceModel && deviceData[deviceType][deviceModel]) {
            const deviceInfo = deviceData[deviceType][deviceModel];
            
            // Populate colors
            deviceColorSelect.disabled = false;
            deviceInfo.colors.forEach(color => {
              const option = document.createElement('option');
              option.value = color;
              option.textContent = color;
              deviceColorSelect.appendChild(option);
            });
            
            // Populate storage
            deviceStorageSelect.disabled = false;
            deviceInfo.storage.forEach(storage => {
              const option = document.createElement('option');
              option.value = storage;
              option.textContent = storage;
                             deviceStorageSelect.appendChild(option);
            });
          }
          
          updateUpgradeModalButtons();
        });

        document.getElementById('upgradeDeviceColor').addEventListener('change', updateUpgradeModalButtons);
        document.getElementById('upgradeDeviceStorage').addEventListener('change', updateUpgradeModalButtons);

        // Upgrade type selection event listeners
        document.querySelectorAll('input[name="upgradeType"]').forEach(radio => {
          radio.addEventListener('change', updateUpgradeModalButtons);
        });

        // Upgrade plan selection event listeners
        document.querySelectorAll('input[name="upgradePlanOption"]').forEach(radio => {
          radio.addEventListener('change', updateUpgradeModalButtons);
        });

        // Add a Line Modal Functions
        function resetModalForm() {
            console.log('Resetting modal form...');
            
            // Reset all form fields
            document.getElementById('deviceType').value = '';
            document.getElementById('deviceModel').value = '';
            document.getElementById('deviceColor').value = '';
            document.getElementById('deviceStorage').value = '';
            document.getElementById('deviceQuantity').value = '1';
            document.getElementById('areaCode').value = '';
            document.getElementById('employeeName').value = '';
            
            // Disable dependent fields
            document.getElementById('deviceModel').disabled = true;
            document.getElementById('deviceColor').disabled = true;
            document.getElementById('deviceStorage').disabled = true;
            
            // Hide device details
            document.getElementById('deviceDetails').style.display = 'none';
            
            // Reset plan selection
            document.querySelectorAll('input[name="planOption"]').forEach(radio => {
                radio.checked = false;
            });
            
            // Reset protection selection
            document.getElementById('noProtection').checked = true;
            
            // Reset trade-in selection
            document.getElementById('noTradeIn').checked = true;
            document.getElementById('tradeInDetails').style.display = 'none';
            
            // Reset trade-in form fields
            document.getElementById('tradeInBrand').value = '';
            document.getElementById('tradeInModel').value = '';
            document.getElementById('tradeInCondition').value = '';
            document.getElementById('tradeInValue').value = '';
            
            console.log('Modal form reset complete');
        }

        function populateModalDropdowns() {
            console.log('Populating modal dropdowns...');
            
            // Populate device type dropdown with data from deviceData
            const deviceTypeSelect = document.getElementById('deviceType');
            if (deviceTypeSelect) {
                // Clear existing hardcoded options
                deviceTypeSelect.innerHTML = '';
                
                // Add default option
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Choose device type...';
                deviceTypeSelect.appendChild(defaultOption);
                
                // Add device type options from deviceData
                Object.keys(deviceData).forEach(deviceType => {
                    const option = document.createElement('option');
                    option.value = deviceType;
                    option.textContent = deviceType.charAt(0).toUpperCase() + deviceType.slice(1);
                    deviceTypeSelect.appendChild(option);
                });
                
                console.log('Device type dropdown populated with', Object.keys(deviceData).length, 'options:', Object.keys(deviceData));
            } else {
                console.error('Device type select element not found');
            }
            
            // Note: Plan and protection options are already hardcoded in HTML
            // The event listeners will handle populating device models, colors, and storage
            console.log('Modal dropdowns populated successfully');
        }

        function updateProgress() {
            console.log('updateProgress called with currentStep:', currentStep);
            
            // Update progress steps - use data-step attribute for accurate step matching
            document.querySelectorAll('#addLineModal .progress-step').forEach((step) => {
                const stepNumber = parseInt(step.getAttribute('data-step'));
                console.log(`Progress step ${stepNumber}:`, step, 'should be active:', stepNumber === currentStep);
                
                step.classList.remove('active', 'completed');
                
                if (stepNumber < currentStep) {
                    step.classList.add('completed');
                    console.log(`Marked progress step ${stepNumber} as completed`);
                } else if (stepNumber === currentStep) {
                    step.classList.add('active');
                    console.log(`Marked progress step ${stepNumber} as active`);
                }
            });
            
            // Show current step content - only select step content within the add line modal
            console.log('=== Updating Step Content Visibility ===');
            document.querySelectorAll('#addLineModal .step-content').forEach((content, index) => {
                const stepNumber = index + 1;
                const shouldBeActive = stepNumber === currentStep;
                console.log(`Step content ${stepNumber}:`, content.id, 'should be active:', shouldBeActive);
                console.log(`Step content ${stepNumber} current classes:`, content.className);
                
                content.classList.remove('active');
                console.log(`Step content ${stepNumber} after removing active:`, content.className);
                
                if (shouldBeActive) {
                    content.classList.add('active');
                    console.log(`Activated step content: ${content.id}`);
                    console.log(`Step content ${stepNumber} final classes:`, content.className);
                    console.log(`Step content ${stepNumber} computed display:`, window.getComputedStyle(content).display);
                    
                    // Force a reflow to ensure the display change takes effect
                    content.offsetHeight;
                }
            });
            
            // Final check of all step content visibility
            console.log('=== Final Step Content Status ===');
            document.querySelectorAll('#addLineModal .step-content').forEach((content, index) => {
                const stepNumber = index + 1;
                const isActive = content.classList.contains('active');
                const computedDisplay = window.getComputedStyle(content).display;
                console.log(`Final - Step ${stepNumber} (${content.id}): active=${isActive}, display=${computedDisplay}`);
            });
        }

        function updateModalButtons() {
            const prevBtn = document.getElementById('prevStepBtn');
            const nextBtn = document.getElementById('nextStepBtn');
            const completeBtn = document.getElementById('completeAddLineOrderBtn');
            
            // Show/hide buttons based on current step
            prevBtn.style.display = currentStep > 1 ? 'block' : 'none';
            nextBtn.style.display = currentStep < 6 ? 'block' : 'none';
            completeBtn.style.display = currentStep === 6 ? 'block' : 'none';
            
            // Update button text
            if (currentStep === 5) {
                nextBtn.textContent = 'Proceed to Checkout';
            } else if (currentStep === 6) {
                nextBtn.style.display = 'none';
            } else {
                nextBtn.textContent = 'Next';
            }
            
            // Enable/disable next button based on validation
            nextBtn.disabled = !validateCurrentStep();
        }

        function validateCurrentStep() {
            console.log('validateCurrentStep called for step:', currentStep);
            
            switch (currentStep) {
                case 1: // Device selection
                    const deviceValid = document.getElementById('deviceType').value && 
                           document.getElementById('deviceModel').value && 
                           document.getElementById('deviceColor').value && 
                           document.getElementById('deviceStorage').value &&
                           document.getElementById('areaCode').value &&
                           document.getElementById('employeeName').value.trim();
                    console.log('Step 1 validation result:', deviceValid);
                    return deviceValid;
                case 2: // Plan selection
                    const planValid = document.querySelector('input[name="planOption"]:checked');
                    console.log('Step 2 validation result:', planValid);
                    return planValid;
                case 3: // Protection selection
                    const protectionValid = document.querySelector('input[name="protectionOption"]:checked');
                    console.log('Step 3 validation result:', protectionValid);
                    return protectionValid;
                case 4: // Trade-in selection
                    const tradeInSelected = document.querySelector('input[name="tradeInOption"]:checked');
                    console.log('Trade-in option selected:', tradeInSelected ? tradeInSelected.value : 'none');
                    
                    if (tradeInSelected && tradeInSelected.value === 'yes') {
                        const tradeInValid = document.getElementById('tradeInBrand').value && 
                               document.getElementById('tradeInModel').value && 
                               document.getElementById('tradeInCondition').value;
                        console.log('Step 4 validation result (with trade-in):', tradeInValid);
                        return tradeInValid;
                    }
                    console.log('Step 4 validation result (no trade-in):', true);
                    return true;
                case 5: // Summary
                    console.log('Step 5 validation result:', true);
                    return true;
                case 6: // Checkout
                    console.log('Step 6 validation result:', true);
                    return true;
                default:
                    console.log('Step validation result (default):', false);
                    return false;
            }
        }

        function saveCurrentStepData() {
            console.log('saveCurrentStepData called for step:', currentStep);
            
            switch (currentStep) {
                case 1:
                    const deviceType = document.getElementById('deviceType').value;
                    const deviceModel = document.getElementById('deviceModel').value;
                    const deviceColor = document.getElementById('deviceColor').value;
                    const deviceStorage = document.getElementById('deviceStorage').value;
                    const deviceQuantity = parseInt(document.getElementById('deviceQuantity').value);
                    const areaCode = document.getElementById('areaCode').value;
                    const employeeName = document.getElementById('employeeName').value.trim();
                    
                    console.log('Step 1 data:', { deviceType, deviceModel, deviceColor, deviceStorage, areaCode, employeeName });
                    
                    if (deviceType && deviceModel && deviceColor && deviceStorage && areaCode && employeeName) {
                        const deviceInfo = deviceData[deviceType][deviceModel];
                        orderData.device = {
                            type: deviceType,
                            model: deviceModel,
                            color: deviceColor,
                            storage: deviceStorage,
                            quantity: deviceQuantity,
                            msrp: deviceInfo.msrp,
                            image: deviceInfo.image
                        };
                        orderData.line = {
                            areaCode: areaCode,
                            employeeName: employeeName
                        };
                        console.log('Step 1 data saved:', orderData);
                    }
                    break;
                case 2:
                    const selectedPlan = document.querySelector('input[name="planOption"]:checked');
                    console.log('Step 2 plan selected:', selectedPlan ? selectedPlan.value : 'none');
                    if (selectedPlan) {
                        const planKey = selectedPlan.value;
                        orderData.plan = {
                            key: planKey,
                            ...planData[planKey]
                        };
                        console.log('Step 2 plan data saved:', orderData.plan);
                    }
                    break;
                case 3:
                    const selectedProtection = document.querySelector('input[name="protectionOption"]:checked');
                    console.log('Step 3 protection selected:', selectedProtection ? selectedProtection.value : 'none');
                    if (selectedProtection) {
                        const protectionKey = selectedProtection.value;
                        orderData.protection = {
                            key: protectionKey,
                            ...protectionData[protectionKey]
                        };
                        console.log('Step 3 protection data saved:', orderData.protection);
                    }
                    break;
                case 4:
                    const tradeInSelected = document.querySelector('input[name="tradeInOption"]:checked');
                    console.log('Step 4 trade-in selected:', tradeInSelected ? tradeInSelected.value : 'none');
                    if (tradeInSelected && tradeInSelected.value === 'yes') {
                        orderData.tradeIn = {
                            brand: document.getElementById('tradeInBrand').value,
                            model: document.getElementById('tradeInModel').value,
                            condition: document.getElementById('tradeInCondition').value,
                            value: parseFloat(document.getElementById('tradeInValue').value) || 0
                        };
                        console.log('Step 4 trade-in data saved:', orderData.tradeIn);
                    } else {
                        orderData.tradeIn = { value: 0 };
                        console.log('Step 4 no trade-in, set value to 0');
                    }
                    break;
            }
        }

        function updateSummary() {
            // Update device summary
            if (orderData.device.model) {
                document.getElementById('summaryDeviceTitle').textContent = `${orderData.device.model} (${orderData.device.quantity})`;
                document.getElementById('summaryDeviceDetails').textContent = 
                    `${orderData.device.color}, ${orderData.device.storage}`;
                document.getElementById('summaryDevicePrice').textContent = 
                    `$${(orderData.device.msrp * orderData.device.quantity).toFixed(2)}`;
                document.getElementById('summaryDeviceMSRP').textContent = 
                    `MSRP: $${(orderData.device.msrp * orderData.device.quantity).toFixed(2)}`;
                document.getElementById('summaryDeviceMonthly').textContent = 
                    `$${((orderData.device.msrp * orderData.device.quantity) / 24).toFixed(2)}/mo.`;
            }
            
            // Update plan summary
            if (orderData.plan.name) {
                document.getElementById('summaryPlanTitle').textContent = 'Plan';
                document.getElementById('summaryPlanDetails').textContent = orderData.plan.name;
                document.getElementById('summaryPlanPrice').textContent = `$${orderData.plan.price.toFixed(2)}/mo.`;
                document.getElementById('summaryPlanMonthly').textContent = `$${orderData.plan.price.toFixed(2)}/mo.`;
            }
            
            // Update protection summary
            if (orderData.protection.name) {
                document.getElementById('summaryProtectionTitle').textContent = 'Device Protection';
                document.getElementById('summaryProtectionDetails').textContent = orderData.protection.name;
                document.getElementById('summaryProtectionPrice').textContent = `$${orderData.protection.price.toFixed(2)}/mo.`;
                document.getElementById('summaryProtectionMonthly').textContent = `$${orderData.protection.price.toFixed(2)}/mo.`;
            }
            
            // Update trade-in summary
            if (orderData.tradeIn.value > 0) {
                document.getElementById('summaryTradeInItem').style.display = 'block';
                document.getElementById('summaryTradeInTitle').textContent = 'Trade-in Credit';
                document.getElementById('summaryTradeInDetails').textContent = 
                    `${orderData.tradeIn.brand} ${orderData.tradeIn.model} (${orderData.tradeIn.condition})`;
                document.getElementById('summaryTradeInValue').textContent = `-$${orderData.tradeIn.value.toFixed(2)}`;
            } else {
                document.getElementById('summaryTradeInItem').style.display = 'none';
            }
            
            // Calculate totals
            const deviceMonthly = orderData.device.msrp ? (orderData.device.msrp * orderData.device.quantity) / 24 : 0;
            const planMonthly = orderData.plan.price || 0;
            const protectionMonthly = orderData.protection.price || 0;
            const totalMonthly = deviceMonthly + planMonthly + protectionMonthly;
            
            const simKitCharge = 20.00;
            const deviceDownPayment = orderData.device.msrp ? (orderData.device.msrp * orderData.device.quantity) * 0.333 : 0;
            const dueNow = simKitCharge + deviceDownPayment - (orderData.tradeIn.value || 0);
            
            document.getElementById('summaryTotalMonthly').textContent = `$${totalMonthly.toFixed(2)}/mo.`;
            document.getElementById('summaryDueNow').textContent = `$${Math.max(0, dueNow).toFixed(2)}`;
            
            // Store summary data
            orderData.summary = {
                deviceMonthly,
                planMonthly,
                protectionMonthly,
                totalMonthly,
                dueNow: Math.max(0, dueNow),
                simKitCharge
            };
        }

        function updateCheckout() {
            // Populate checkout order summary
            const checkoutSummary = document.getElementById('checkoutOrderSummary');
            let summaryHTML = '';
            
            if (orderData.device.model) {
                summaryHTML += `
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h6 class="mb-1">${orderData.device.model} (${orderData.device.quantity})</h6>
                            <div class="text-muted small">${orderData.device.color}, ${orderData.device.storage}</div>
                        </div>
                        <div class="text-end">
                            <span class="h6 text-primary">$${((orderData.device.msrp * orderData.device.quantity) / 24).toFixed(2)}/mo.</span>
                        </div>
                    </div>
                `;
            }
            
            if (orderData.plan.name) {
                summaryHTML += `
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h6 class="mb-1">${orderData.plan.name}</h6>
                        </div>
                        <div class="text-end">
                            <span class="h6 text-primary">$${orderData.plan.price.toFixed(2)}/mo.</span>
                        </div>
                    </div>
                `;
            }
            
            if (orderData.protection.name && orderData.protection.price > 0) {
                summaryHTML += `
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h6 class="mb-1">${orderData.protection.name}</h6>
                        </div>
                        <div class="text-end">
                            <span class="h6 text-primary">$${orderData.protection.price.toFixed(2)}/mo.</span>
                        </div>
                    </div>
                `;
            }
            
            checkoutSummary.innerHTML = summaryHTML;
            
            // Update checkout totals
            const subtotal = orderData.summary.dueNow;
            const taxes = Math.round(subtotal * 0.08 * 100) / 100; // 8% tax
            const total = subtotal + taxes;
            
            document.getElementById('checkoutSubtotalFinal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('checkoutTaxesFinal').textContent = `$${taxes.toFixed(2)}`;
            document.getElementById('checkoutTotalFinal').textContent = `$${total.toFixed(2)}`;
        }

        // Event listeners for modal functionality
        document.getElementById('nextStepBtn').addEventListener('click', function() {
            console.log('Next button clicked. Current step:', currentStep);
            console.log('Validation result:', validateCurrentStep());
            
            if (validateCurrentStep()) {
                console.log('Validation passed, saving current step data...');
                saveCurrentStepData();
                console.log('Current step data saved:', orderData);
                
                const previousStep = currentStep;
                currentStep++;
                console.log(`Step incremented from ${previousStep} to ${currentStep}`);
                
                console.log('About to call updateProgress...');
                updateProgress();
                console.log('updateProgress completed');
                
                console.log('About to call updateModalButtons...');
                updateModalButtons();
                console.log('updateModalButtons completed');
                
                if (currentStep === 5) {
                    console.log('Moving to summary step');
                    updateSummary();
                } else if (currentStep === 6) {
                    console.log('Moving to checkout step');
                    updateCheckout();
                }
                
                // Debug: Check what step content is currently visible
                console.log('=== Step Content Visibility Check ===');
                document.querySelectorAll('.step-content').forEach((content, index) => {
                    const stepNumber = index + 1;
                    const isActive = content.classList.contains('active');
                    const computedDisplay = window.getComputedStyle(content).display;
                    console.log(`Step ${stepNumber} (${content.id}): active=${isActive}, display=${computedDisplay}`);
                });
            } else {
                console.log('Validation failed for step:', currentStep);
            }
        });

        document.getElementById('prevStepBtn').addEventListener('click', function() {
            if (currentStep > 1) {
                currentStep--;
                updateProgress();
                updateModalButtons();
            }
        });

        document.getElementById('completeAddLineOrderBtn').addEventListener('click', async function() {
            // Disable button and show loading state
            const completeBtn = this;
            completeBtn.disabled = true;
            completeBtn.textContent = 'Processing...';
            
            try {
                const requestData = {
                    account_id: currentAccountId,
                    device: orderData.device,
                    plan: orderData.plan,
                    protection: orderData.protection,
                    tradeIn: orderData.tradeIn,
                    line: orderData.line,
                    summary: orderData.summary
                };
                
                const response = await fetch('/api/lines/create/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    // Success - close modal and show confirmation
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addLineModal'));
                    modal.hide();
                    
                    setTimeout(() => {
                        showComingSoonModal(
                            'Line Created Successfully!', 
                            `Your new line has been created successfully!\n\nLine Details:\n• Phone Number: ${data.line.msdn}\n• Employee: ${data.line.employee_name}\n• Device: ${data.line.device_details}\n• Plan: ${data.line.plan_name}\n\nYou will receive confirmation via SMS and email. Device will be shipped within 2-3 business days.`
                        );
                        
                        // Navigate back to account summary to show the new line
                        setTimeout(() => {
                            window.location.href = window.location.pathname + '?line_added=true';
                        }, 3000);
                    }, 300);
                } else {
                    // Error from API
                    alert(`Error: ${data.error || 'Failed to create line'}`);
                }
                
            } catch (error) {
                console.error('Error creating line:', error);
                alert('Error: Failed to create line. Please try again.');
            }
            
            // Re-enable button
            completeBtn.disabled = false;
            completeBtn.textContent = 'Complete Order';
        });

        // Device selection event listeners
        document.getElementById('deviceType').addEventListener('change', function() {
            console.log('Device type changed to:', this.value);
            const deviceType = this.value;
            const deviceModelSelect = document.getElementById('deviceModel');
            const deviceColorSelect = document.getElementById('deviceColor');
            const deviceStorageSelect = document.getElementById('deviceStorage');
            
            console.log('Device model select element:', deviceModelSelect);
            console.log('Device color select element:', deviceColorSelect);
            console.log('Device storage select element:', deviceStorageSelect);
            
            // Reset dependent fields
            deviceModelSelect.innerHTML = '<option value="">Select device type first...</option>';
            deviceColorSelect.innerHTML = '<option value="">Select model first...</option>';
            deviceStorageSelect.innerHTML = '<option value="">Select model first...</option>';
            deviceColorSelect.disabled = true;
            deviceStorageSelect.disabled = true;
            
            if (deviceType && deviceData[deviceType]) {
                console.log('Device data found for:', deviceType, deviceData[deviceType]);
                deviceModelSelect.disabled = false;
                Object.keys(deviceData[deviceType]).forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    deviceModelSelect.appendChild(option);
                });
                console.log('Device models populated:', deviceModelSelect.options.length);
            } else {
                console.log('No device data found for:', deviceType);
                deviceModelSelect.disabled = true;
            }
            
            updateModalButtons();
        });

        document.getElementById('deviceModel').addEventListener('change', function() {
            console.log('Device model changed to:', this.value);
            const deviceType = document.getElementById('deviceType').value;
            const deviceModel = this.value;
            const deviceColorSelect = document.getElementById('deviceColor');
            const deviceStorageSelect = document.getElementById('deviceStorage');
            
            // Reset dependent fields
            deviceColorSelect.innerHTML = '<option value="">Select model first...</option>';
            deviceStorageSelect.innerHTML = '<option value="">Select model first...</option>';
            deviceColorSelect.disabled = true;
            deviceStorageSelect.disabled = true;
            
            if (deviceType && deviceModel && deviceData[deviceType][deviceModel]) {
                const deviceInfo = deviceData[deviceType][deviceModel];
                console.log('Device info found:', deviceInfo);
                
                // Populate colors
                deviceColorSelect.disabled = false;
                deviceInfo.colors.forEach(color => {
                    const option = document.createElement('option');
                    option.value = color;
                    option.textContent = color;
                    deviceColorSelect.appendChild(option);
                });
                
                // Populate storage
                deviceStorageSelect.disabled = false;
                deviceInfo.storage.forEach(storage => {
                    const option = document.createElement('option');
                    option.value = storage;
                    option.textContent = storage;
                    deviceStorageSelect.appendChild(option);
                });
            } else {
                console.log('No device info found for:', deviceType, deviceModel);
            }
            
            updateModalButtons();
        });

        document.getElementById('deviceColor').addEventListener('change', updateModalButtons);
        document.getElementById('deviceStorage').addEventListener('change', updateModalButtons);
        document.getElementById('areaCode').addEventListener('change', updateModalButtons);
        document.getElementById('employeeName').addEventListener('input', updateModalButtons);

        // Device details update
        function updateDeviceDetails() {
            const deviceType = document.getElementById('deviceType').value;
            const deviceModel = document.getElementById('deviceModel').value;
            const deviceColor = document.getElementById('deviceColor').value;
            const deviceStorage = document.getElementById('deviceStorage').value;
            
            if (deviceType && deviceModel && deviceColor && deviceStorage) {
                const deviceInfo = deviceData[deviceType][deviceModel];
                const deviceDetails = document.getElementById('deviceDetails');
                
                document.getElementById('deviceImage').src = deviceInfo.image;
                document.getElementById('deviceTitle').textContent = deviceModel;
                document.getElementById('deviceDescription').textContent = `${deviceColor}, ${deviceStorage}`;
                document.getElementById('deviceMSRP').textContent = `$${deviceInfo.msrp.toFixed(2)}`;
                
                deviceDetails.style.display = 'block';
            } else {
                document.getElementById('deviceDetails').style.display = 'none';
            }
        }

        document.getElementById('deviceColor').addEventListener('change', updateDeviceDetails);
        document.getElementById('deviceStorage').addEventListener('change', updateDeviceDetails);

        // Plan selection event listeners
        document.querySelectorAll('input[name="planOption"]').forEach(radio => {
            radio.addEventListener('change', function() {
                console.log('Plan selected:', this.value);
                console.log('Plan validation result:', document.querySelector('input[name="planOption"]:checked'));
                updateModalButtons();
            });
        });

        // Protection selection event listeners
        document.querySelectorAll('input[name="protectionOption"]').forEach(radio => {
            radio.addEventListener('change', function() {
                console.log('Protection selected:', this.value);
                console.log('Protection validation result:', document.querySelector('input[name="protectionOption"]:checked'));
                updateModalButtons();
            });
        });

        // Trade-in selection event listeners
        document.querySelectorAll('input[name="tradeInOption"]').forEach(radio => {
            radio.addEventListener('change', function() {
                console.log('Trade-in option selected:', this.value);
                const tradeInDetails = document.getElementById('tradeInDetails');
                tradeInDetails.style.display = (this.value === 'yes') ? 'block' : 'none';
                updateModalButtons();
            });
        });

        // Trade-in value calculation
        document.getElementById('tradeInCondition').addEventListener('change', function() {
            const brand = document.getElementById('tradeInBrand').value;
            const model = document.getElementById('tradeInModel').value;
            const condition = this.value;
            
            if (brand && model && condition) {
                // Simple trade-in value calculation
                let baseValue = 200; // Base value for any device
                const conditionMultiplier = {
                    'excellent': 1.0,
                    'good': 0.8,
                    'fair': 0.6,
                    'poor': 0.3
                };
                
                const calculatedValue = baseValue * conditionMultiplier[condition];
                document.getElementById('tradeInValue').value = calculatedValue.toFixed(2);
            }
        });

        // Trade-in form validation
        document.getElementById('tradeInBrand').addEventListener('change', updateModalButtons);
        document.getElementById('tradeInModel').addEventListener('input', updateModalButtons);
        document.getElementById('tradeInCondition').addEventListener('change', updateModalButtons);

        // Edit Line Details Functions
        // Add event listeners for edit line buttons
        document.addEventListener('DOMContentLoaded', function() {
          document.querySelectorAll('.edit-line-btn').forEach(button => {
            button.addEventListener('click', function() {
              const lineId = this.dataset.lineId;
              const lineName = this.dataset.lineName;
              const employeeName = this.dataset.employeeName;
              const currentDate = this.dataset.paymentDate;
              editLinePaymentDate(lineId, lineName, employeeName, currentDate);
            });
          });
        });

        function editLinePaymentDate(lineId, lineName, employeeName, currentDate) {
            currentEditingLineId = lineId;
            document.getElementById('editLineName').textContent = lineName;
            document.getElementById('editEmployeeName').value = employeeName;
            document.getElementById('editPaymentDate').value = currentDate;
            
            const modal = new bootstrap.Modal(document.getElementById('editPaymentDateModal'));
            modal.show();
        }

        document.getElementById('savePaymentDateBtn').addEventListener('click', async function() {
            const employeeName = document.getElementById('editEmployeeName').value.trim();
            const paymentDate = document.getElementById('editPaymentDate').value;
            
            if (!employeeName) {
                alert('Please enter an employee name');
                return;
            }
            
            if (!paymentDate) {
                alert('Please select a payment due date');
                return;
            }
            
            const saveBtn = this;
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';
            
            try {
                const response = await fetch('/api/lines/update-details/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        line_id: currentEditingLineId,
                        employee_name: employeeName,
                        payment_date: paymentDate
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editPaymentDateModal'));
                    modal.hide();
                    
                    // Show success message
                    alert('Line details updated successfully!');
                    
                    // Refresh the page to show updated data
                    window.location.reload();
                } else {
                    alert(`Error: ${data.error || 'Failed to update line details'}`);
                }
            } catch (error) {
                console.error('Error updating line details:', error);
                alert('Error: Failed to update line details. Please try again.');
            }
            
            // Re-enable button
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save Changes';
        });
        
    </script>
</body>
</html> 